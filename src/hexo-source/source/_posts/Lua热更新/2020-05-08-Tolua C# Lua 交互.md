---
title: ToLua C# 与 Lua 交互详解 - 虚拟机架构与调用链路
date: 2020/05/08
categories: [技术文章, Lua/热更新]
tags: [Unity, ToLua, C#, Lua, 交互, CLR, IL2CPP, 虚拟机]
---

# ToLua C# 与 Lua 交互详解 - 虚拟机架构与调用链路

> 深入解析 Unity 中 C# 与 Lua 的跨语言交互机制，涵盖 .NET 虚拟机架构、IL2CPP 原理以及 ToLua 的完整调用链路。

---

## 一、交互链路概览

### 1.1 完整调用链

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    C# ↔ Lua 完整调用链路                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  C# 调用 Lua:                                                            │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐ │
│  │ C# 代码  │──>│ToLua C# │──>│LuaDLL  │──>│tolua.c │──>│Lua 代码 │ │
│  └─────────┘   └─────────┘   └─────────┘   └─────────┘   └─────────┘ │
│                                                                         │
│  Lua 调用 C#:                                                            │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐ │
│  │ Lua 代码 │──>│Wrap文件 │──>│ToLua.CS│──>│C# 代码  │   │         │ │
│  └─────────┘   └─────────┘   └─────────┘   └─────────┘   └─────────┘ │
│                                                                         │
│  涉及的基础知识:                                                           │
│  • C# 语言特性 (IL/CLR)                                                   │
│  • Lua 虚拟机                                                              │
│  • C/C++ 与 C# 互操作 (P/Invoke)                                           │
│  • C 与 Lua 交互                                                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 双向交互流程

| 方向 | 路径 | 说明 |
|-----|------|------|
| **C# → Lua** | C# → LuaDLL → tolua.c → Lua | 调用 Lua 函数、操作 Lua 表 |
| **Lua → C#** | Lua → Wrap → ToLua.CS → C# | 访问 C# 对象、调用 C# 方法 |

---

## 二、.NET 虚拟机架构

### 2.1 核心概念

| 术语 | 全称 | 说明 |
|-----|------|------|
| **CIL/IL** | Common Intermediate Language | 面向对象的汇编语言，基于堆栈 |
| **CLR** | Common Language Runtime | 公共语言运行时（虚拟机） |
| **CLI** | Common Language Infrastructure | CIL + CLR 的集合 |
| **JIT** | Just In Time | 即时编译器 |
| **AOT** | Ahead Of Time | 提前编译 |

### 2.2 编译执行流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    .NET 代码编译执行流程                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Mono VM 流程:                                                           │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌──────┐│
│  │  C#     │───>│   IL    │───>│   JIT   │───>│机器码  │───>│ CPU  ││
│  │  源码   │    │中间语言 │    │编译器   │    │        │    │      ││
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘    └──────┘│
│                                                                         │
│  IL2CPP 流程:                                                            │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌──────┐│
│  │  C#     │───>│   IL    │───>│IL2CPP   │───>│ C++    │───>│Native││
│  │  源码   │    │中间语言 │    │转换器   │    │代码    │    │编译  ││
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘    └──────┘│
│                                          │                            │             │
│                                          ▼                            ▼             │
│                                   ┌─────────┐    ┌─────────────────┐              │
│                                   │IL2CPP VM│    │ Native 可执行文件 │             │
│                                   │(GC等)   │    │   (.exe/.so)     │              │
│                                   └─────────┘    └─────────────────┘              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.3 IL2CPP 优势

| 优势 | 说明 |
|-----|------|
| **运行效率** | 直接编译为原生代码，接近 C++ 性能 |
| **平台优化** | 利用各平台 C++ 编译器优化 |
| **内存管理** | 内置 GC 组件，简化内存管理 |
| **线程支持** | 内置线程创建和同步 |

### 2.4 AOT 编译限制

> ⚠️ **重要**：由于 C++ 是静态语言，AOT 编译意味着：
> - 交互方式/方法在打包前已确定
> - 无法运行时动态生成新方法
> - 热更新需要通过 Lua 等脚本语言实现

---

## 三、Unity 虚拟机演进

### 3.1 Unity 历史虚拟机

| 版本 | 虚拟机 | 特点 |
|-----|-------|------|
| **早期 Unity** | Mono VM | 支持 Boo、C#、JavaScript |
| **Unity 5.x** | Mono VM | 主要使用 C#，Boo 逐渐淘汰 |
| **Unity 2017+** | IL2CPP | C++ 转译，性能提升 |
| **Unity 2018+** | IL2CPP (默认) | Mono 逐渐作为备用选项 |

### 3.2 工程链对比

```
Mono 工程链:
C# 源码 → IL 中间语言 → Mono VM → 机器码 → CPU

IL2CPP 工程链:
C# 源码 → IL 中间语言 → IL2CPP → C++ 代码 → Native 编译器 → Native 可执行文件 → IL2CPP VM (GC 等)
```

---

## 四、调用链详细分析

### 4.1 C# 调用 Lua

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    C# → Lua 调用流程                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  C# 代码:                                                                │
│  ┌─────────────────────────────────────┐                                │
│  │ LuaFunction func = luaState.GetFunction("test", true);             │
│  │ func.Call();                                                        │
│  │ // 或使用 ToLua.CallFunc()           │                                │
│  └─────────────────────────────────────┘                                │
│         │                                                                │
│         ▼                                                                │
│  ToLua.CS 层:                                                            │
│  ┌─────────────────────────────────────┐                                │
│  │ LuaFunction.Call()                                                │
│  │   ├── 参数准备/压栈                                                 │
│  │   ├── 调用 LuaDLL.lua_pcall()                                     │
│  │   └── 返回值处理/出栈                                               │
│  └─────────────────────────────────────┘                                │
│         │                                                                │
│         ▼                                                                │
│  LuaDLL.cs 层:                                                           │
│  ┌─────────────────────────────────────┐                                │
│  │ [DllImport("tolua")]                                              │
│  │ public static extern int lua_pcall(IntPtr L, int nargs, ...);     │
│  └─────────────────────────────────────┘                                │
│         │                                                                │
│         ▼                                                                │
│  tolua.c / Lua 虚拟机层:                                                 │
│  ┌─────────────────────────────────────┐                                │
│  │ lua_pcall()  →  执行 Lua 函数                                  │
│  │ lua_gettop()  →  获取栈顶位置                                   │
│  │ lua_settop()  →  设置栈顶位置                                   │
│  │ lua_toxxx()   →  获取返回值                                     │
│  └─────────────────────────────────────┘                                │
│         │                                                                │
│         ▼                                                                │
│  Lua 代码:                                                               │
│  ┌─────────────────────────────────────┐                                │
│  │ function test()                                                    │
│  │     print("Hello from Lua!")                                     │
│  │ end                                                                │
│  └─────────────────────────────────────┘                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 Lua 调用 C#

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Lua → C# 调用流程                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Lua 代码:                                                               │
│  ┌─────────────────────────────────────┐                                  │
│  │ local gameObject = CS.UnityEngine.GameObject()                     │
│  │ local transform = gameObject.transform                                 │
│  │ transform.position = Vector3.zero                                     │
│  └─────────────────────────────────────┘                                  │
│         │                                                                │
│         ▼                                                                │
│  Wrap 文件层 (预生成):                                                   │
│  ┌─────────────────────────────────────┐                                │
│  │ GameObjectWrap.cs                                                  │
│  │   ├── 接收 Lua 参数                                               │
│  │   ├── 类型转换 (Lua → C#)                                        │
│  │   └── 调用真正的 C# GameObject                                 │
│  └─────────────────────────────────────┘                                │
│         │                                                                │
│         ▼                                                                │
│  ToLua.CS 层:                                                            │
│  ┌─────────────────────────────────────┐                                │
│  │ ToLua.ToObject()  →  从 Lua userdata 获取 C# 对象                 │
│  │ ObjectTranslator.GetObject() →  通过索引获取对象                    │
│  └─────────────────────────────────────┘                                │
│         │                                                                │
│         ▼                                                                │
│  C# 对象:                                                                │
│  ┌─────────────────────────────────────┐                                │
│  │ UnityEngine.GameObject                                         │
│  │   ├── 属性访问                                                     │
│  │   ├── 方法调用                                                     │
│  │   └── 事件处理                                                     │
│  └─────────────────────────────────────┘                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 五、核心概念澄清

### 5.1 虚拟机分类

| 分类方式 | 类型 | 示例 |
|-------|------|------|
| **执行模型** | 栈虚拟机 | JVM、.NET CLR |
| | 寄存器虚拟机 | Lua、LuaJIT |
| **编译时机** | JIT 编译 | Mono VM、V8 |
| | AOT 编译 | IL2CPP |
| | 解释执行 | Python、Ruby |

### 5.2 C# 与 C++ 区别

| 特性 | C# | C++ |
|-----|-----|-----|
| **类型** | 托管/值类型混合 | 值类型为主 |
| **内存** | GC 自动管理 | 手动管理 |
| **编译** | → IL → JIT/AOT | 直接编译为机器码 |
| **动态特性** | 支持 (反射) | 有限 |

### 5.3 为什么选择 Lua 热更新

| 方案 | iOS | Android | 优缺点 |
|-----|-----|--------|-------|
| **Lua** | ✅ 支持 | ✅ 支持 | 轻量，稳定 |
| **C# JIT** | ❌ 不支持 | ✅ 可能支持 | iOS 无法 JIT |
| **Assembly** | ❌ 不支持 | ❌ 困难 | 体积大 |

---

## 六、总结

| 主题 | 要点 |
|-----|------|
| **调用链** | C# → LuaDLL → tolua.c → Lua |
| **反向调用** | Lua → Wrap → ToLua.CS → C# |
| **IL2CPP** | AOT 编译，C++ 转译，原生性能 |
| **虚拟机** | Mono vs IL2CPP，各有优劣 |
| **热更新** | Lua 绕过 iOS 代码签名限制 |

> 💡 **学习建议**：
> - 从 Lua 基础开始学习
> - 理解 C/C++ 与 C# 互操作
> - 最后研究 ToLua C# 层实现
> - 多用 Log 和断点调试

---

**转载请注明来源**，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 1487842110@qq.com
