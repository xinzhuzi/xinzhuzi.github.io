---
title: Lua C API å®Œå…¨æŒ‡å— - C/C++ ä¸ Lua äº¤äº’è¯¦è§£
date: 2020/05/08
categories: [æŠ€æœ¯æ–‡ç« , Lua/çƒ­æ›´æ–°]
tags: [Lua, C, C++, API, æ ˆ, äº¤äº’, tolua]
---

# Lua C API å®Œå…¨æŒ‡å— - C/C++ ä¸ Lua äº¤äº’è¯¦è§£

> æ·±å…¥è§£æ Lua C APIï¼Œæ¶µç›–æ ˆæ“ä½œã€æ•°æ®ä¼ é€’ã€å‡½æ•°è°ƒç”¨ç­‰æ ¸å¿ƒæœºåˆ¶ï¼Œæ˜¯ç†è§£ ToLua æ¡†æ¶åº•å±‚åŸç†çš„åŸºç¡€ã€‚

---

## ä¸€ã€Lua C API æ¦‚è¿°

### 1.1 æ ¸å¿ƒæ¦‚å¿µ

| æ¦‚å¿µ | è¯´æ˜ |
|-----|------|
| **lua_State** | Lua è™šæ‹Ÿæœºå®ä¾‹ï¼Œç»´æŠ¤ç‹¬ç«‹çš„æ‰§è¡Œç¯å¢ƒ |
| **Lua æ ˆ** | C ä¸ Lua äº¤æ¢æ•°æ®çš„ä¸­ä»‹ |
| **ç´¢å¼•æ–¹å¼** | æ­£ç´¢å¼•ï¼ˆä»åº•åˆ°é¡¶ï¼‰ã€è´Ÿç´¢å¼•ï¼ˆä»é¡¶åˆ°åº•ï¼‰ |
| **ä¼ªç´¢å¼•** | è®¿é—®æ³¨å†Œè¡¨ã€å…¨å±€è¡¨ç­‰ç‰¹æ®Šä½ç½® |

### 1.2 æ ˆç»“æ„ç¤ºæ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Lua è™šæ‹Ÿæœºæ ˆç»“æ„                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  lua_State æ ˆ:                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç´¢å¼•æ–¹å¼:                                                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚  â”‚  1  â”‚  2  â”‚  3  â”‚  4  â”‚ ... â”‚ -3  â”‚ -2  â”‚ -1  â”‚             â”‚   â”‚
â”‚  â”‚  â”‚     â”‚     â”‚     â”‚     â”‚     â”‚     â”‚     â”‚     â”‚             â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â”‚    â”‚                                               â”‚             â”‚   â”‚
â”‚  â”‚    â””â”€â”€ æ­£ç´¢å¼• (ä»åº•åˆ°é¡¶)        è´Ÿç´¢å¼• (ä»é¡¶åˆ°åº•) â”€â”€â”˜             â”‚   â”‚
â”‚  â”‚                                                                â”‚   â”‚
â”‚  â”‚  æ ˆé¡¶ (-1) æ˜¯æœ€æ–°å‹å…¥çš„å…ƒç´                                       â”‚   â”‚
â”‚  â”‚  æ ˆåº• (1) æ˜¯æœ€æ—©çš„å…ƒç´                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  ä¼ªç´¢å¼• (ç‰¹æ®Šç”¨é€”):                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  LUA_REGISTRYINDEX  â†’  æ³¨å†Œè¡¨ (C ä»£ç ä½¿ç”¨)                       â”‚   â”‚
â”‚  â”‚  LUA_GLOBALSINDEX   â†’  å…¨å±€è¡¨ _G (Lua ä»£ç ä½¿ç”¨)                  â”‚   â”‚
â”‚  â”‚  LUA_ENVIRONINDEX   â†’  ç¯å¢ƒè¡¨                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€å‹æ ˆæ“ä½œ (Push Operations)

### 2.1 å‹å…¥åŸºç¡€ç±»å‹

| API | åŠŸèƒ½ | æ ˆå˜åŒ– |
|-----|------|-------|
| `lua_pushnil` | å‹å…¥ nil | æ ˆé¡¶ +1 |
| `lua_pushboolean` | å‹å…¥å¸ƒå°”å€¼ | æ ˆé¡¶ +1 |
| `lua_pushnumber` | å‹å…¥æ•°å­— | æ ˆé¡¶ +1 |
| `lua_pushinteger` | å‹å…¥æ•´æ•° | æ ˆé¡¶ +1 |

### 2.2 å‹å…¥å­—ç¬¦ä¸²

| API | åŠŸèƒ½ | è¯´æ˜ |
|-----|------|------|
| `lua_pushstring` | å‹å…¥ C å­—ç¬¦ä¸² (ä»¥ \0 ç»“å°¾) | è‡ªåŠ¨å¤åˆ¶ |
| `lua_pushlstring` | å‹å…¥å¸¦é•¿åº¦çš„å­—ç¬¦ä¸² | å¯åŒ…å« \0 |
| `lua_pushfstring` | æ ¼å¼åŒ–å­—ç¬¦ä¸²å‹æ ˆ | ç±»ä¼¼ printf |
| `lua_pushvfstring` | vlist ç‰ˆæœ¬æ ¼å¼åŒ–å­—ç¬¦ä¸² | å˜å‚åˆ—è¡¨ |
| `lua_pushliteral` | å‹å…¥å­—ç¬¦ä¸²å­—é¢é‡ | ä¼˜åŒ–ç‰ˆæœ¬ |

### 2.3 å‹å…¥ç‰¹æ®Šå¯¹è±¡

| API | åŠŸèƒ½ | æ ˆå˜åŒ– |
|-----|------|-------|
| `lua_pushcfunction` | å‹å…¥ C å‡½æ•° | æ ˆé¡¶ +1 |
| `lua_pushcclosure` | å‹å…¥ C é—­åŒ… | æ”¯æŒä¸Šå€¼ |
| `lua_pushlightuserdata` | å‹å…¥è½»é‡ç”¨æˆ·æ•°æ® | æŒ‡é’ˆä¼ é€’ |
| `lua_pushthread` | å‹å…¥çº¿ç¨‹å¯¹è±¡ | åç¨‹æ”¯æŒ |
| `lua_pushvalue` | å¤åˆ¶æŒ‡å®šä½ç½®åˆ°æ ˆé¡¶ | æ ˆé¡¶ +1 |

### 2.4 å‹æ ˆä»£ç ç¤ºä¾‹

```c
// å‹å…¥å„ç§ç±»å‹åˆ° Lua æ ˆ
void push_values_example(lua_State *L) {
    lua_pushnil(L);           // æ ˆ: [nil]
    lua_pushboolean(L, 1);    // æ ˆ: [nil, true]
    lua_pushinteger(L, 42);   // æ ˆ: [nil, true, 42]
    lua_pushnumber(L, 3.14);  // æ ˆ: [nil, true, 42, 3.14]
    lua_pushstring(L, "hello"); // æ ˆ: [nil, true, 42, 3.14, "hello"]
    lua_pushvalue(L, -5);     // æ ˆ: [nil, true, 42, 3.14, "hello", nil]

    // æ­¤æ—¶æ ˆé¡¶ (-1) æ˜¯ nilï¼Œ-5 ä½ç½®ä¹Ÿæ˜¯ nil
}
```

---

## ä¸‰ã€ç±»å‹æ£€æŸ¥ (Type Checking)

### 3.1 ç±»å‹åˆ¤æ–­å‡½æ•°

| API | æ£€æŸ¥ç±»å‹ | è¿”å›å€¼ |
|-----|---------|-------|
| `lua_type` | è·å–ç±»å‹æšä¸¾ | LUA_TNIL, LUA_TBOOLEAN, ç­‰ |
| `lua_typename` | ç±»å‹åç§°å­—ç¬¦ä¸² | "nil", "boolean", "number", ç­‰ |
| `lua_isboolean` | æ˜¯å¦ä¸ºå¸ƒå°” | int (0/1) |
| `lua_iscfunction` | æ˜¯å¦ä¸º C å‡½æ•° | int (0/1) |
| `lua_isfunction` | æ˜¯å¦ä¸ºå‡½æ•° (å« Lua å‡½æ•°) | int (0/1) |
| `lua_islightuserdata` | æ˜¯å¦ä¸ºè½»é‡ç”¨æˆ·æ•°æ® | int (0/1) |
| `lua_isnil` | æ˜¯å¦ä¸º nil | int (0/1) |
| `lua_isnone` | ç´¢å¼•æ˜¯å¦æ— æ•ˆ | int (0/1) |
| `lua_isnoneornil` | æ— æ•ˆæˆ– nil | int (0/1) |
| `lua_isnumber` | æ˜¯å¦ä¸ºæ•°å­— | int (0/1) |
| `lua_isstring` | æ˜¯å¦ä¸ºå­—ç¬¦ä¸² | int (0/1) |
| `lua_istable` | æ˜¯å¦ä¸ºè¡¨ | int (0/1) |
| `lua_isthread` | æ˜¯å¦ä¸ºçº¿ç¨‹ | int (0/1) |
| `lua_isuserdata` | æ˜¯å¦ä¸ºç”¨æˆ·æ•°æ® | int (0/1) |

### 3.2 Lua ç±»å‹å¸¸é‡

```c
// Lua 8 ç§åŸºç¡€ç±»å‹
#define LUA_TNONE          (-1)
#define LUA_TNIL            0
#define LUA_TBOOLEAN        1
#define LUA_TLIGHTUSERDATA  2
#define LUA_TNUMBER         3
#define LUA_TSTRING         4
#define LUA_TTABLE          5
#define LUA_TFUNCTION       6
#define LUA_TUSERDATA       7
#define LUA_TTHREAD         8
```

### 3.3 ç±»å‹æ£€æŸ¥ç¤ºä¾‹

```c
void check_types_example(lua_State *L) {
    // æ£€æŸ¥æ ˆé¡¶å…ƒç´ çš„ç±»å‹
    int type = lua_type(L, -1);

    switch (type) {
        case LUA_TNIL:
            printf("æ ˆé¡¶æ˜¯ nil\n");
            break;
        case LUA_TBOOLEAN:
            printf("æ ˆé¡¶æ˜¯å¸ƒå°”å€¼: %d\n", lua_toboolean(L, -1));
            break;
        case LUA_TNUMBER:
            printf("æ ˆé¡¶æ˜¯æ•°å­—: %f\n", lua_tonumber(L, -1));
            break;
        case LUA_TSTRING:
            printf("æ ˆé¡¶æ˜¯å­—ç¬¦ä¸²: %s\n", lua_tostring(L, -1));
            break;
        case LUA_TTABLE:
            printf("æ ˆé¡¶æ˜¯è¡¨\n");
            break;
        case LUA_TFUNCTION:
            printf("æ ˆé¡¶æ˜¯å‡½æ•°\n");
            break;
        case LUA_TUSERDATA:
            printf("æ ˆé¡¶æ˜¯ç”¨æˆ·æ•°æ®\n");
            break;
        case LUA_TTHREAD:
            printf("æ ˆé¡¶æ˜¯çº¿ç¨‹\n");
            break;
    }

    // ä½¿ç”¨ä¾¿æ·æ£€æŸ¥å‡½æ•°
    if (lua_isnumber(L, 2)) {
        printf("ç´¢å¼• 2 æ˜¯æ•°å­—\n");
    }

    if (lua_isstring(L, 3)) {
        printf("ç´¢å¼• 3 æ˜¯å­—ç¬¦ä¸²ï¼ˆæˆ–å¯è½¬ä¸ºå­—ç¬¦ä¸²ï¼‰\n");
    }
}
```

---

## å››ã€å–å€¼æ“ä½œ (To Operations)

### 4.1 è·å–æ ˆå…ƒç´ 

| API | è¿”å›ç±»å‹ | åŠŸèƒ½ |
|-----|---------|------|
| `lua_toboolean` | int | è½¬ä¸ºå¸ƒå°”å€¼ |
| `lua_tocfunction` | lua_CFunction | è·å– C å‡½æ•°æŒ‡é’ˆ |
| `lua_tointeger` | lua_Integer | è·å–æ•´æ•°å€¼ |
| `lua_tonumber` | lua_Number | è·å–æµ®ç‚¹æ•°å€¼ |
| `lua_tolstring` | const char* | è·å–å­—ç¬¦ä¸²ï¼ˆå¯å« \0ï¼‰ |
| `lua_tostring` | const char* | è·å–å­—ç¬¦ä¸² |
| `lua_topointer` | const void* | è·å–æŒ‡é’ˆï¼ˆç”¨äºç›¸ç­‰æ¯”è¾ƒï¼‰ |
| `lua_tothread` | lua_State* | è·å–çº¿ç¨‹å¯¹è±¡ |
| `lua_touserdata` | void* | è·å–ç”¨æˆ·æ•°æ® |

### 4.2 å–å€¼æ³¨æ„äº‹é¡¹

> âš ï¸ **é‡è¦**ï¼šæ‰€æœ‰ `lua_to*` å‡½æ•°ç­¾åï¼š
> ```c
> type lua_toxxx(lua_State *L, int index);
> ```
> - `L`: å½“å‰ Lua çŠ¶æ€æœº
> - `index`: æ ˆä¸Šçš„ä½ç½®ï¼ˆæ­£ç´¢å¼•ã€è´Ÿç´¢å¼•ã€ä¼ªç´¢å¼•ï¼‰

### 4.3 å–å€¼ç¤ºä¾‹

```c
void get_values_example(lua_State *L) {
    // å‡è®¾æ ˆä¸Šæœ‰: [nil, true, 42, 3.14, "hello"]

    // è·å–å¸ƒå°”å€¼ (ç´¢å¼• -4)
    int b = lua_toboolean(L, -4);  // b = 1

    // è·å–æ•´æ•°å€¼ (ç´¢å¼• -3)
    lua_Integer i = lua_tointeger(L, -3);  // i = 42

    // è·å–æµ®ç‚¹æ•°å€¼ (ç´¢å¼• -2)
    lua_Number n = lua_tonumber(L, -2);  // n = 3.14

    // è·å–å­—ç¬¦ä¸² (ç´¢å¼• -1)
    const char *s = lua_tostring(L, -1);  // s = "hello"
    size_t len;
    const char *s2 = lua_tolstring(L, -1, &len);  // s2 = "hello", len = 5

    // è·å– C å‡½æ•°
    if (lua_iscfunction(L, -5)) {
        lua_CFunction f = lua_tocfunction(L, -5);
    }

    // è·å–ç”¨æˆ·æ•°æ®
    if (lua_isuserdata(L, some_index)) {
        void *ud = lua_touserdata(L, some_index);
    }
}
```

---

## äº”ã€æ ˆæ“ä½œ (Stack Manipulation)

### 5.1 æ ˆç®¡ç†å‡½æ•°

| API | åŠŸèƒ½ | æ ˆå˜åŒ– |
|-----|------|-------|
| `lua_gettop` | è·å–æ ˆé¡¶ä½ç½®ï¼ˆå³æ ˆå¤§å°ï¼‰ | æ— å˜åŒ– |
| `lua_settop` | è®¾ç½®æ ˆé¡¶ä½ç½® | å¯å¢å¯å‡ |
| `lua_remove` | åˆ é™¤æŒ‡å®šä½ç½®å…ƒç´  | æ ˆå¤§å° -1 |
| `lua_insert` | å°†æ ˆé¡¶æ’å…¥æŒ‡å®šä½ç½® | æ ˆå¤§å°ä¸å˜ |
| `lua_replace` | ç”¨æ ˆé¡¶æ›¿æ¢æŒ‡å®šä½ç½® | æ ˆå¤§å° -1 |
| `lua_pop` | å¼¹å‡º n ä¸ªå…ƒç´  | å®: lua_settop(L, -n-1) |

### 5.2 æ ˆæ“ä½œè¯¦è§£

#### lua_settop

```c
void lua_settop(lua_State *L, int index);
```

| index å‚æ•° | æ•ˆæœ |
|-----------|------|
| **æ­£æ•°** | è®¾ç½®æ ˆé¡¶ä¸ºè¯¥ä½ç½®ï¼Œåˆ é™¤ä¸Šæ–¹æ‰€æœ‰å…ƒç´  |
| **å¤§äºå½“å‰æ ˆå¤§å°** | ç”¨ nil å¡«å……åˆ°æ–°ä½ç½® |
| **0** | æ¸…ç©ºæ•´ä¸ªæ ˆ |
| **è´Ÿæ•°** | ç›¸å½“äº `lua_gettop() + index + 1` |

```c
// lua_settop ç¤ºä¾‹
lua_settop(L, 5);   // è®¾ç½®æ ˆé¡¶ä¸º 5ï¼Œåˆ é™¤ 6 åŠä»¥ä¸Šçš„å…ƒç´ 
lua_settop(L, 0);   // æ¸…ç©ºæ ˆ
lua_settop(L, -3);  // åªä¿ç•™æ ˆåº• 3 ä¸ªå…ƒç´ 
```

#### lua_remove

```c
void lua_remove(lua_State *L, int index);
```

- åˆ é™¤æŒ‡å®šæœ‰æ•ˆç´¢å¼•å¤„çš„å…ƒç´ 
- ä¸Šæ–¹å…ƒç´ ä¸‹ç§»å¡«å……ç©ºç¼º
- **ä¸èƒ½ä½¿ç”¨ä¼ªç´¢å¼•**

```c
// lua_remove ç¤ºä¾‹
// æ ˆ: [1, 2, 3, 4, 5]
lua_remove(L, 2);  // æ ˆ: [1, 3, 4, 5]
lua_remove(L, -1); // æ ˆ: [1, 3, 4]
```

#### lua_insert

```c
void lua_insert(lua_State *L, int index);
```

- å°†æ ˆé¡¶å…ƒç´ ç§»åŠ¨åˆ°æŒ‡å®šä½ç½®
- æŒ‡å®šä½ç½®åˆ°æ ˆé¡¶çš„å…ƒç´ ä¸Šç§»
- **ä¸èƒ½ä½¿ç”¨ä¼ªç´¢å¼•**

```c
// lua_insert ç¤ºä¾‹
// æ ˆ: [1, 2, 3, 4, 5]
lua_insert(L, 2);  // æ ˆ: [1, 5, 2, 3, 4]
```

#### lua_replace

```c
void lua_replace(lua_State *L, int index);
```

- ç”¨æ ˆé¡¶å…ƒç´ æ›¿æ¢æŒ‡å®šä½ç½®çš„å€¼
- å¼¹å‡ºæ ˆé¡¶ï¼ˆæ ˆå¤§å° -1ï¼‰
- å…¶ä»–å…ƒç´ ä½ç½®ä¸å˜

```c
// lua_replace ç¤ºä¾‹
// æ ˆ: [1, 2, 3, 4, 5]
lua_replace(L, 2);  // æ ˆ: [1, 5, 3, 4]
```

### 5.3 æ ˆæ“ä½œå®

```c
// å¸¸ç”¨å®å®šä¹‰
#define lua_pop(L,n)        lua_settop(L, -(n)-1)
#define lua_newtable(L)     lua_createtable(L, 0, 0)
#define lua_register(L,n,f) (lua_pushcfunction(L, (f)), lua_setglobal(L, (n)))
#define lua_pushcfunction(L,f)  lua_pushcclosure(L, (f), 0)
```

---

## å…­ã€å‡½æ•°è°ƒç”¨ (Function Call)

### 6.1 lua_call è¯¦è§£

```c
void lua_call(lua_State *L, int nargs, int nresults);
```

**è°ƒç”¨åè®®ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        lua_call è°ƒç”¨æµç¨‹                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  è°ƒç”¨å‰:                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ ... â”‚ arg1 â”‚ arg2 â”‚ ... â”‚ å‡½æ•°å¯¹è±¡                           â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                            â–²                                            â”‚
â”‚                            â”‚ æ ˆåº•æ–¹å‘                                    â”‚
â”‚                                                                         â”‚
â”‚  è°ƒç”¨ lua_call(L, nargs, nresults):                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. å¼¹å‡ºå‡½æ•°å’Œæ‰€æœ‰å‚æ•°                                          â”‚   â”‚
â”‚  â”‚  2. æ‰§è¡Œå‡½æ•°                                                    â”‚   â”‚
â”‚  â”‚  3. å°†ç»“æœå‹å…¥æ ˆï¼ˆæŒ‰ç›´æ¥é¡ºåºï¼Œç¬¬ä¸€ä¸ªç»“æœå…ˆå…¥ï¼‰                   â”‚   â”‚
â”‚  â”‚  4. è°ƒæ•´ç»“æœæ•°é‡ä¸º nresults                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  è°ƒç”¨å (nresults = 2):                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ ... â”‚res1 â”‚ res2                                            â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                            â–²                                            â”‚
â”‚                            â”‚ æ ˆåº•æ–¹å‘                                    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 å‡½æ•°è°ƒç”¨å‚æ•°

| å‚æ•° | è¯´æ˜ | ç‰¹æ®Šå€¼ |
|-----|------|-------|
| `nargs` | å‚æ•°ä¸ªæ•° | å¿…é¡»åŒ¹é…å®é™…å‹å…¥çš„å‚æ•°æ•° |
| `nresults` | æœŸæœ›ç»“æœæ•° | `LUA_MULTRET` è¡¨ç¤ºæ¥å—æ‰€æœ‰è¿”å›å€¼ |

### 6.3 å‡½æ•°è°ƒç”¨ç¤ºä¾‹

```c
// è°ƒç”¨ Lua å‡½æ•°ç¤ºä¾‹
void call_lua_function(lua_State *L) {
    // å‡è®¾ Lua ä¸­å®šä¹‰: function add(a, b) return a + b, a - b end

    // 1. è·å–å‡½æ•°å¹¶å‹æ ˆ
    lua_getglobal(L, "add");     // æ ˆ: [add]

    // 2. å‹å…¥å‚æ•°
    lua_pushinteger(L, 10);     // æ ˆ: [add, 10]
    lua_pushinteger(L, 5);      // æ ˆ: [add, 10, 5]

    // 3. è°ƒç”¨å‡½æ•° (2ä¸ªå‚æ•°, 2ä¸ªè¿”å›å€¼)
    lua_call(L, 2, 2);          // æ ˆ: [15, 5]

    // 4. è·å–ç»“æœ
    lua_Integer sum = lua_tointeger(L, -2);  // 15
    lua_Integer diff = lua_tointeger(L, -1); // 5

    // 5. æ¸…ç†ç»“æœ
    lua_pop(L, 2);              // æ ˆ: []
}
```

---

## ä¸ƒã€å…¨å±€è¡¨ä¸æ³¨å†Œè¡¨

### 7.1 è¡¨ç»“æ„å¯¹æ¯”

| ç‰¹æ€§ | å…¨å±€è¡¨ _G | æ³¨å†Œè¡¨ |
|-----|----------|--------|
| **ç”¨é€”** | Lua ä»£ç å…¨å±€å˜é‡å­˜å‚¨ | C ä»£ç ç§æœ‰æ•°æ®å­˜å‚¨ |
| **è®¿é—®æ–¹å¼** | `LUA_GLOBALSINDEX` | `LUA_REGISTRYINDEX` |
| **å¯è§æ€§** | Lua ä»£ç å¯è§ | ä»… C ä»£ç å¯è§ |
| **ç”Ÿå‘½å‘¨æœŸ** | ä¸ lua_State ç›¸åŒ | ä¸ lua_State ç›¸åŒ |

### 7.2 æ³¨å†Œè¡¨ä½¿ç”¨

```c
// æ³¨å†Œè¡¨å­˜å‚¨ C å¯¹è±¡ç¤ºä¾‹
void registry_example(lua_State *L) {
    // åˆ›å»ºä¸€ä¸ª Lua è¡¨ä½œä¸ºå‘½åç©ºé—´
    lua_newtable(L);                    // æ ˆ: [table]

    // å­˜å‚¨ C æŒ‡é’ˆåˆ°æ³¨å†Œè¡¨
    lua_pushlightuserdata(L, (void*)my_object);  // æ ˆ: [table, pointer]
    lua_setfield(L, -2, "my_object");            // æ ˆ: [table]

    // å°†è¡¨å­˜å…¥æ³¨å†Œè¡¨
    lua_setfield(L, LUA_REGISTRYINDEX, "MyNamespace");  // æ ˆ: []

    // ä»æ³¨å†Œè¡¨è¯»å–
    lua_getfield(L, LUA_REGISTRYINDEX, "MyNamespace"); // æ ˆ: [table]
    lua_getfield(L, -1, "my_object");                // æ ˆ: [table, pointer]
    void *obj = lua_touserdata(L, -1);               // è·å–æŒ‡é’ˆ
    lua_pop(L, 2);                                  // æ¸…ç†
}
```

---

## å…«ã€å®Œæ•´ç¤ºä¾‹

### 8.1 C è°ƒç”¨ Lua å‡½æ•°

```c
#include <lua.h>
#include <lauxlib.h>
#include <lualib.h>

int main() {
    // 1. åˆ›å»º Lua çŠ¶æ€
    lua_State *L = luaL_newstate();

    // 2. åŠ è½½æ ‡å‡†åº“
    luaL_openlibs(L);

    // 3. æ‰§è¡Œ Lua ä»£ç 
    const char *lua_code = R"(
        function greet(name)
            return "Hello, " .. name .. "!"
        end

        function sum(a, b)
            return a + b
        end
    )";

    if (luaL_dostring(L, lua_code) != LUA_OK) {
        fprintf(stderr, "Error: %s\n", lua_tostring(L, -1));
        return 1;
    }

    // 4. è°ƒç”¨ greet å‡½æ•°
    lua_getglobal(L, "greet");         // å‹å…¥å‡½æ•°
    lua_pushstring(L, "World");        // å‹å…¥å‚æ•°
    lua_call(L, 1, 1);                 // è°ƒç”¨ (1å‚æ•°, 1è¿”å›å€¼)

    const char *result = lua_tostring(L, -1);
    printf("%s\n", result);            // è¾“å‡º: Hello, World!
    lua_pop(L, 1);                     // æ¸…ç†ç»“æœ

    // 5. è°ƒç”¨ sum å‡½æ•°
    lua_getglobal(L, "sum");
    lua_pushinteger(L, 10);
    lua_pushinteger(L, 20);
    lua_call(L, 2, 1);

    int sum_result = lua_tointeger(L, -1);
    printf("Sum: %d\n", sum_result);   // è¾“å‡º: Sum: 30
    lua_pop(L, 1);

    // 6. å…³é—­ Lua çŠ¶æ€
    lua_close(L);

    return 0;
}
```

### 8.2 Lua è°ƒç”¨ C å‡½æ•°

```c
#include <lua.h>
#include <lauxlib.h>
#include <lualib.h>

// C å‡½æ•°ï¼šè®¡ç®—ä¸¤ä¸ªæ•°çš„å¹³å‡å€¼
static int average(lua_State *L) {
    // æ£€æŸ¥å‚æ•°æ•°é‡
    int n = lua_gettop(L);    // è·å–å‚æ•°ä¸ªæ•°
    if (n != 2) {
        lua_pushstring(L, "é”™è¯¯: éœ€è¦ 2 ä¸ªå‚æ•°");
        lua_error(L);         // æŠ›å‡ºé”™è¯¯
        return 0;
    }

    // æ£€æŸ¥å‚æ•°ç±»å‹
    if (!lua_isnumber(L, 1) || !lua_isnumber(L, 2)) {
        lua_pushstring(L, "é”™è¯¯: å‚æ•°å¿…é¡»æ˜¯æ•°å­—");
        lua_error(L);
        return 0;
    }

    // è·å–å‚æ•°
    double a = lua_tonumber(L, 1);
    double b = lua_tonumber(L, 2);

    // è®¡ç®—å¹¶å‹å…¥ç»“æœ
    lua_pushnumber(L, (a + b) / 2.0);

    return 1;  // è¿”å›å€¼ä¸ªæ•°
}

// C å‡½æ•°ï¼šè¿”å›å¤šä¸ªå€¼
static int divide_mod(lua_State *L) {
    int a = lua_tointeger(L, 1);
    int b = lua_tointeger(L, 2);

    if (b == 0) {
        lua_pushstring(L, "é™¤æ•°ä¸èƒ½ä¸º 0");
        lua_error(L);
        return 0;
    }

    lua_pushinteger(L, a / b);      // å•†
    lua_pushinteger(L, a % b);      // ä½™æ•°

    return 2;  // è¿”å› 2 ä¸ªå€¼
}

int main() {
    lua_State *L = luaL_newstate();
    luaL_openlibs(L);

    // æ³¨å†Œ C å‡½æ•°åˆ° Lua
    lua_register(L, "average", average);
    lua_register(L, "divide_mod", divide_mod);

    // æ‰§è¡Œ Lua ä»£ç è°ƒç”¨ C å‡½æ•°
    const char *lua_code = R"(
        print("å¹³å‡æ•°:", average(10, 20))

        local q, r = divide_mod(17, 5)
        print("17 / 5 =", q, ", ä½™æ•° =", r)
    )";

    if (luaL_dostring(L, lua_code) != LUA_OK) {
        fprintf(stderr, "Error: %s\n", lua_tostring(L, -1));
    }

    lua_close(L);
    return 0;
}
```

---

## ä¹ã€API é€ŸæŸ¥è¡¨

### 9.1 æ ˆæ“ä½œé€ŸæŸ¥

| æ“ä½œ | API | å¤‡æ³¨ |
|-----|-----|------|
| è·å–æ ˆå¤§å° | `lua_gettop` | è¿”å›æ ˆé¡¶ç´¢å¼• |
| è®¾ç½®æ ˆå¤§å° | `lua_settop` | å¯å¡«å…… nil æˆ–åˆ é™¤ |
| å¼¹å‡ºå…ƒç´  | `lua_pop` | å®: `lua_settop(L, -n-1)` |
| åˆ é™¤å…ƒç´  | `lua_remove` | ä¸Šæ–¹å…ƒç´ ä¸‹ç§» |
| æ’å…¥å…ƒç´  | `lua_insert` | æ ˆé¡¶æ’å…¥æŒ‡å®šä½ç½® |
| æ›¿æ¢å…ƒç´  | `lua_replace` | æ ˆé¡¶æ›¿æ¢ï¼Œå¼¹å‡ºæ ˆé¡¶ |

### 9.2 å‹æ ˆé€ŸæŸ¥

| ç±»å‹ | API |
|-----|-----|
| nil | `lua_pushnil` |
| å¸ƒå°” | `lua_pushboolean` |
| æ•°å­— | `lua_pushnumber`, `lua_pushinteger` |
| å­—ç¬¦ä¸² | `lua_pushstring`, `lua_pushlstring`, `lua_pushfstring` |
| C å‡½æ•° | `lua_pushcfunction`, `lua_pushcclosure` |
| è¡¨ | `lua_newtable`, `lua_createtable` |
| ç”¨æˆ·æ•°æ® | `lua_newuserdata`, `lua_pushlightuserdata` |

### 9.3 æ£€æŸ¥é€ŸæŸ¥

| ç±»å‹ | æ£€æŸ¥å‡½æ•° | è·å–å‡½æ•° |
|-----|---------|---------|
| nil | `lua_isnil` | - |
| å¸ƒå°” | `lua_isboolean` | `lua_toboolean` |
| æ•°å­— | `lua_isnumber` | `lua_tonumber`, `lua_tointeger` |
| å­—ç¬¦ä¸² | `lua_isstring` | `lua_tostring`, `lua_tolstring` |
| è¡¨ | `lua_istable` | - |
| å‡½æ•° | `lua_isfunction`, `lua_iscfunction` | `lua_tocfunction` |
| ç”¨æˆ·æ•°æ® | `lua_isuserdata`, `lua_islightuserdata` | `lua_touserdata` |
| çº¿ç¨‹ | `lua_isthread` | `lua_tothread` |
| ä»»æ„ç±»å‹ | `lua_type` | - |

---

## åã€æ€»ç»“

| ä¸»é¢˜ | è¦ç‚¹ |
|-----|------|
| **æ ˆæœºåˆ¶** | C ä¸ Lua äº¤æ¢æ•°æ®çš„å”¯ä¸€ä¸­ä»‹ |
| **ç´¢å¼•æ–¹å¼** | æ­£ç´¢å¼•ä»åº•åˆ°é¡¶ï¼Œè´Ÿç´¢å¼•ä»é¡¶åˆ°åº• |
| **å‹å…¥æ•°æ®** | `lua_push*` ç³»åˆ—ï¼Œæ ˆé¡¶ +1 |
| **è·å–æ•°æ®** | `lua_to*` ç³»åˆ—ï¼Œä¸æ”¹å˜æ ˆ |
| **ç±»å‹æ£€æŸ¥** | `lua_is*` å’Œ `lua_type` |
| **å‡½æ•°è°ƒç”¨** | `lua_call` éœ€æŒ‰åè®®å‹å…¥å‡½æ•°å’Œå‚æ•° |
| **æ³¨å†Œè¡¨** | C ä»£ç ç§æœ‰å­˜å‚¨ï¼Œä¸ _G éš”ç¦» |

> ğŸ’¡ **å­¦ä¹ å»ºè®®**ï¼š
> - ç†Ÿè®°æ ˆçš„ç´¢å¼•æ–¹å¼ï¼ˆæ­£/è´Ÿç´¢å¼•ï¼‰
> - æ³¨æ„æ¯æ¬¡æ“ä½œåæ ˆçš„çŠ¶æ€å˜åŒ–
> - ä½¿ç”¨ `lua_gettop()` æ£€æŸ¥æ ˆå¤§å°è¿›è¡Œè°ƒè¯•
> - æ³¨æ„ `lua_to*` ä¸æ”¹å˜æ ˆï¼Œ`lua_push*` å¢åŠ æ ˆ
> - æ³¨å†Œè¡¨ç”¨äºå­˜å‚¨ C ä»£ç çš„ç§æœ‰æ•°æ®

---

**è½¬è½½è¯·æ³¨æ˜æ¥æº**ï¼Œæ¬¢è¿å¯¹æ–‡ç« ä¸­çš„å¼•ç”¨æ¥æºè¿›è¡Œè€ƒè¯ï¼Œæ¬¢è¿æŒ‡å‡ºä»»ä½•æœ‰é”™è¯¯æˆ–ä¸å¤Ÿæ¸…æ™°çš„è¡¨è¾¾ã€‚å¯ä»¥åœ¨ä¸‹é¢è¯„è®ºåŒºè¯„è®ºï¼Œä¹Ÿå¯ä»¥é‚®ä»¶è‡³ 1487842110@qq.com
