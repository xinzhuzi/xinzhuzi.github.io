---
title: C# ä¸ C/C++ äº’æ“ä½œå®Œå…¨æŒ‡å— - ToLua æ¡†æ¶ä¸‹çš„ P/Invoke å®æˆ˜
date: 2020/05/08
categories: [æŠ€æœ¯æ–‡ç« , Lua/çƒ­æ›´æ–°]
tags: [C#, C++, ToLua, P/Invoke, äº’æ“ä½œ, DllImport, Marshal, Unity]
---

# C# ä¸ C/C++ äº’æ“ä½œå®Œå…¨æŒ‡å— - ToLua æ¡†æ¶ä¸‹çš„ P/Invoke å®æˆ˜

> æœ¬æ–‡æ·±å…¥æ¢è®¨ .NET å¹³å°ä¸‹æ‰˜ç®¡ä»£ç ï¼ˆC#ï¼‰ä¸éæ‰˜ç®¡ä»£ç ï¼ˆC/C++ï¼‰ä¹‹é—´çš„äº’æ“ä½œæŠ€æœ¯ï¼Œè¿™æ˜¯ç†è§£ ToLua æ¡†æ¶åº•å±‚åŸç†çš„é‡è¦åŸºç¡€ã€‚

---

## ä¸€ã€æ¨èé˜…è¯»ä¹¦ç±

### 1.1 æ ¸å¿ƒä¹¦ç±

| ä¹¦å | ä½œè€… | è¯‘è€… | é‡ç‚¹å†…å®¹ |
|-----|------|------|---------|
| **.NET æ¢ç§˜ï¼šMSIL æƒå¨æŒ‡å—** | Serge Lidin | åŒ…å»ºå¼º | IL æŒ‡ä»¤é›†ã€CLR å†…éƒ¨æœºåˆ¶ |
| **.NET CLR via C# (ç¬¬4ç‰ˆ)** | Jeffrey Richter | å‘¨é– | CLR æ ¸å¿ƒã€è¿è¡Œæ—¶æœºåˆ¶ |
| **ç²¾é€š .NET äº’æ“ä½œ** | é»„é™…æ´²ã€å´”æ™“æº | - | P/Invokeã€C++ Interopã€COM Interop |

---

## äºŒã€C# åŸºç¡€çŸ¥è¯†

### 2.1 ç‰¹æ€§ (Attribute)

**ç‰¹æ€§ (Attribute)** æ˜¯ä¸€ç§å¯ç”±ç”¨æˆ·è‡ªç”±å®šä¹‰çš„ä¿®é¥°ç¬¦ï¼Œç”¨äºæ·»åŠ å…ƒæ•°æ®ã€‚

```csharp
// å®šä¹‰ç‰¹æ€§
[AttributeUsage(AttributeTargets.Class | AttributeTargets.Method)]
public class MyCustomAttribute : Attribute
{
    public string Description { get; set; }
}

// ä½¿ç”¨ç‰¹æ€§
[MyCustom(Description = "This is a sample class")]
public class SampleClass
{
    [MyCustom]
    public void SampleMethod() { }
}

// é€šè¿‡åå°„è·å–ç‰¹æ€§
var attributes = typeof(SampleClass).GetCustomAttributes(typeof(MyCustomAttribute), true);
```

### 2.2 å€¼ç±»å‹ä¸å¼•ç”¨ç±»å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         C# ç±»å‹ä½“ç³»                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚                    System.Object                                        â”‚
â”‚                          â”‚                                              â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚            â”‚                           â”‚                                â”‚
â”‚      å¼•ç”¨ç±»å‹ (Reference)        å€¼ç±»å‹ (Value)                         â”‚
â”‚      (class, interface,           â”‚                                   â”‚
â”‚       string, object)      System.ValueType                            â”‚
â”‚                                â”‚                                       â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                    â”‚                       â”‚                            â”‚
â”‚              æšä¸¾ (enum)           ç»“æ„ä½“ (struct)                      â”‚
â”‚                                        â”‚                               â”‚
â”‚              åŸºæœ¬æ•°å€¼ç±»å‹ (int, float, bool, char, ...)                  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 è£…ç®±ä¸æ‹†ç®±

| æ“ä½œ | è¯´æ˜ | ç¤ºä¾‹ |
|-----|------|------|
| **è£…ç®±** | å€¼ç±»å‹ â†’ å¼•ç”¨ç±»å‹ | `object obj = 42;` |
| **æ‹†ç®±** | å¼•ç”¨ç±»å‹ â†’ å€¼ç±»å‹ | `int i = (int)obj;` |

```csharp
// è£…ç®±ç¤ºä¾‹
int value = 123;
object obj = value;  // è£…ç®±: å€¼ç±»å‹å¤åˆ¶åˆ°å †ä¸Š

// æ‹†ç®±ç¤ºä¾‹
int newValue = (int)obj;  // æ‹†ç®±: ä»å †å¤åˆ¶å›æ ˆ

// åœ¨ IL ä¸­æŸ¥çœ‹ (ä½¿ç”¨ Rider IL Viewer)
// box [mscorlib] System.Int32  â† è£…ç®±æŒ‡ä»¤
// unbox.any [mscorlib] System.Int32  â† æ‹†ç®±æŒ‡ä»¤
```

> âš ï¸ **æ³¨æ„**ï¼šè£…ç®±/æ‹†ç®±ä¼šäº§ç”Ÿæ€§èƒ½å¼€é”€ï¼Œåº”å°½é‡é¿å…é¢‘ç¹å‘ç”Ÿã€‚

### 2.4 ToLua ä¸­çš„ LuaDLL

```csharp
// LuaDLL.cs åŒ…å« C# è°ƒç”¨ C/C++ çš„å‡½æ•°åº“
// ä¸åŒå¹³å° mono ä¼šåŠ è½½å¯¹åº”çš„ tolua.dll/tolu.so ç­‰æ–‡ä»¶

public partial class LuaDLL
{
    #if UNITY_IOS && !UNITY_EDITOR
    internal const string LUA_DLL = "__Internal";
    #else
    internal const string LUA_DLL = "tolua";
    #endif

    [DllImport(LUA_DLL, CallingConvention = CallingConvention.Cdecl)]
    public static extern IntPtr lua_open();

    [DllImport(LUA_DLL, CallingConvention = CallingConvention.Cdecl)]
    public static extern void lua_close(IntPtr L);
}
```

---

## ä¸‰ã€äº’æ“ä½œæŠ€æœ¯æ¦‚è¿°

### 3.1 ä¸‰ç§äº’æ“ä½œæ–¹å¼

| æŠ€æœ¯ | ç”¨é€” | ç‰¹ç‚¹ |
|-----|------|------|
| **P/Invoke** | æ‰˜ç®¡ä»£ç è°ƒç”¨éæ‰˜ç®¡ DLL | åŠ¨æ€åŠ è½½ï¼ŒæŸ¥æ‰¾å‡½æ•°å…¥å£åœ°å€ |
| **C++ Interop** | æ‰˜ç®¡ C++ è°ƒç”¨éæ‰˜ç®¡ C++ | æºç çº§é“¾æ¥ï¼Œç¼–è¯‘åˆ°åŒä¸€ç¨‹åºé›† |
| **COM Interop** | .NET è°ƒç”¨ COM ç»„ä»¶ | Windows å¹³å°ä¸“ç”¨ |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    äº’æ“ä½œæŠ€æœ¯å¯¹æ¯”                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  P/Invoke (å¹³å°è°ƒç”¨):                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  æ‰˜ç®¡ä»£ç    â”‚â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  éæ‰˜ç®¡DLL   â”‚         â”‚  æ“ä½œç³»ç»Ÿ   â”‚      â”‚
â”‚  â”‚   (C#)      â”‚         â”‚  (ç¼–è¯‘å)    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”‚   API       â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚      æŸ¥æ‰¾DLLå…¥å£ç‚¹                                                     â”‚
â”‚                                                                         â”‚
â”‚  C++ Interop:                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    ç¼–è¯‘é“¾æ¥    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚  æ‰˜ç®¡C++    â”‚===============>â”‚  éæ‰˜ç®¡C++   â”‚                        â”‚
â”‚  â”‚ (åŒ…è£…å±‚)    â”‚   åŒä¸€ç¨‹åºé›†    â”‚  (ç±»åº“)     â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚      æºç çº§é“¾æ¥                                                        â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å››ã€P/Invoke å¹³å°è°ƒç”¨è¯¦è§£

### 4.1 è°ƒç”¨è¿‡ç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    P/Invoke è°ƒç”¨æµç¨‹                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â‘  æŸ¥æ‰¾ DLL                                                             â”‚
â”‚     â””â”€â”€ CLR æœç´¢è·¯å¾„: åº”ç”¨ç›®å½• â†’ System32 â†’ ç¯å¢ƒå˜é‡è·¯å¾„                  â”‚
â”‚                                                                         â”‚
â”‚  â‘¡ åŠ è½½ DLL åˆ°å†…å­˜                                                       â”‚
â”‚     â””â”€â”€ LoadLibrary() Win32 API                                         â”‚
â”‚                                                                         â”‚
â”‚  â‘¢ æŸ¥æ‰¾å‡½æ•°å…¥å£ç‚¹                                                        â”‚
â”‚     â””â”€â”€ GetProcAddress() è·å–å‡½æ•°åœ°å€                                   â”‚
â”‚                                                                         â”‚
â”‚  â‘£ å°é€å‚æ•°                                                              â”‚
â”‚     â””â”€â”€ å°†æ‰˜ç®¡æ•°æ®è½¬æ¢ä¸ºéæ‰˜ç®¡æ ¼å¼                                       â”‚
â”‚                                                                         â”‚
â”‚  â‘¤ å‹æ ˆå¹¶è°ƒç”¨                                                            â”‚
â”‚     â””â”€â”€ æŒ‰ç…§è°ƒç”¨çº¦å®šå°†å‚æ•°å‹å…¥æ ˆ                                         â”‚
â”‚                                                                         â”‚
â”‚  â‘¥ è¿”å›å€¼å¤„ç†                                                            â”‚
â”‚     â””â”€â”€ å°†éæ‰˜ç®¡è¿”å›å€¼å°é€å›æ‰˜ç®¡æ ¼å¼                                     â”‚
â”‚                                                                         â”‚
â”‚  âš¡ æ€§èƒ½ä¼˜åŒ–: CLR ä¼šç¼“å­˜å‡½æ•°åœ°å€ï¼Œåç»­è°ƒç”¨ç›´æ¥ä½¿ç”¨ç¼“å­˜                    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 è°ƒç”¨çº¦å®š (CallingConvention)

| çº¦å®š | å †æ ˆæ¸…ç† | è¯´æ˜ |
|-----|---------|------|
| **Winapi** | å¹³å°é»˜è®¤ | Windows ä¸Š = StdCallï¼ŒWinCE ä¸Š = CDecl |
| **CDecl** | è°ƒç”¨è€…æ¸…ç† | æ”¯æŒå¯å˜å‚æ•° (å¦‚ printf) |
| **StdCall** | è¢«è°ƒç”¨è€…æ¸…ç† | éæ‰˜ç®¡å‡½æ•°é»˜è®¤çº¦å®š |
| **ThisCall** | è¢«è°ƒç”¨è€…æ¸…ç† | ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ this æŒ‡é’ˆ (ECX) |
| **FastCall** | - | C# ä¸æ”¯æŒ |

---

## äº”ã€C# è°ƒç”¨ C/C++

### 5.1 C++ éæ‰˜ç®¡ä»£ç 

```cpp
// NativeLib.cpp
extern "C"
{
    // å¯¼å‡ºå‡½æ•°: è·å–æ•°æ®æ•°ç»„
    extern void GetAllData(
        const char *config_name,    // é…ç½®åç§°
        void **ptrArray,            // è¾“å‡ºæ•°æ®æŒ‡é’ˆæ•°ç»„
        int &arraySize              // è¾“å‡ºæ•°ç»„å¤§å°
    )
    {
        // å®ç°é€»è¾‘...
        arraySize = 100;
        ptrArray[0] = malloc(1024);
    }
}
```

### 5.2 C# DllImport å£°æ˜

```csharp
using System;
using System.Runtime.InteropServices;

public static class NativeMethods
{
    private const string LibName = "NativeLib";

    [DllImport(LibName,
        CallingConvention = CallingConvention.Cdecl,
        EntryPoint = "GetAllData")]
    public static extern unsafe void GetAllDataImpl(
        string config_name,
        [In, Out] IntPtr[] data,
        ref int len);
}
```

### 5.3 C# æ‰˜ç®¡ä»£ç è°ƒç”¨

```csharp
public class DataProvider
{
    private const int PINVOKE_ARRAY_LEN = 65536;
    private static IntPtr[] pInvoke_Array = new IntPtr[PINVOKE_ARRAY_LEN];

    public static unsafe IntPtr[] GetAllData(string config_name, ref int count)
    {
        // æ¸…ç©ºæ•°ç»„
        Array.Clear(pInvoke_Array, 0, pInvoke_Array.Length);

        // è°ƒç”¨éæ‰˜ç®¡å‡½æ•°
        NativeMethods.GetAllDataImpl(config_name, pInvoke_Array, ref count);

        return pInvoke_Array;
    }
}
```

---

## å…­ã€C/C++ è°ƒç”¨ C# (å›è°ƒ)

### 6.1 C++ éæ‰˜ç®¡ä»£ç 

```cpp
// NativeLib.cpp
extern "C"
{
    // å®šä¹‰å§”æ‰˜ç±»å‹
    typedef void (*NoParamDelegate)();
    typedef void (*StringParamDelegate)(const char *del1);

    // æ¥å—å§”æ‰˜çš„å‡½æ•°
    extern void DoSomething(
        NoParamDelegate del1,
        StringParamDelegate del2)
    {
        del1();                          // è°ƒç”¨æ— å‚å›è°ƒ
        del2("Hello from C++");         // è°ƒç”¨å­—ç¬¦ä¸²å‚æ•°å›è°ƒ
    }
}
```

### 6.2 C# å§”æ‰˜å®šä¹‰

```csharp
using System;
using System.Runtime.InteropServices;

public class CallbackDemo : MonoBehaviour
{
    // DllImport å£°æ˜
    [DllImport("__Internal")]
    private static extern void DoSomething(
        NoParamDelegate del1,
        StringParamDelegate del2);

    // å§”æ‰˜ç±»å‹å®šä¹‰
    public delegate void NoParamDelegate();
    public delegate void StringParamDelegate(string str);

    // æ— å‚å›è°ƒ
    [MonoPInvokeCallback(typeof(NoParamDelegate))]
    public static void NoParamCallback()
    {
        Debug.Log("Hello from NoParamCallback - è¢« C/C++ è°ƒç”¨");
    }

    // å­—ç¬¦ä¸²å‚æ•°å›è°ƒ
    [MonoPInvokeCallback(typeof(StringParamDelegate))]
    public static void StringParamCallback(string str)
    {
        Debug.Log($"Hello from StringParamCallback: {str}");
    }

    // åˆå§‹åŒ–
    void Start()
    {
        DoSomething(NoParamCallback, StringParamCallback);
    }
}
```

### 6.3 å›è°ƒæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å›è°ƒè°ƒç”¨æµç¨‹                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  æ‰˜ç®¡ä»£ç  (C#)                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚  â”‚  å®šä¹‰å§”æ‰˜   â”‚                                                         â”‚
â”‚  â”‚  å®ç°å›è°ƒ   â”‚                                                         â”‚
â”‚  â”‚  Start()    â”‚                                                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                         â”‚
â”‚         â”‚ DoSomething(callback1, callback2)                             â”‚
â”‚         â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚     DllImport / MonoPInvokeCallback â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚         â”‚                                                                 â”‚
â”‚         â–¼                                                                 â”‚
â”‚  éæ‰˜ç®¡ä»£ç  (C/C++)                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚  â”‚DoSomething()â”‚                                                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                         â”‚
â”‚         â”‚                                                                 â”‚
â”‚         â”œâ”€â”€> del1() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> NoParamCallback()                 â”‚
â”‚         â”‚                                                                 â”‚
â”‚         â””â”€â”€> del2("msg") â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> StringParamCallback(string)      â”‚
â”‚                    â–²                                                        â”‚
â”‚                    â”‚                                                       â”‚
â”‚              æ‰˜ç®¡ä»£ç è¢«è°ƒç”¨                                                â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸ƒã€DllImport å‚æ•°è¯¦è§£

### 7.1 å®Œæ•´å‚æ•°è¡¨

| å‚æ•° | ç±»å‹ | è¯´æ˜ | æ¨èå€¼ |
|-----|------|------|-------|
| `CallingConvention` | enum | è°ƒç”¨çº¦å®š | CDecl / StdCall |
| `EntryPoint` | string | DLL å…¥å£ç‚¹åç§° | æ˜¾å¼æŒ‡å®š |
| `CharSet` | enum | å­—ç¬¦ç¼–ç  | Unicode / Auto |
| `SetLastError` | bool | æ˜¯å¦è°ƒç”¨ SetLastError | false |
| `ExactSpelling` | bool | ç¦ç”¨åç§°ä¿®é¥° | true (æ€§èƒ½ä¼˜åŒ–) |
| `PreserveSig` | bool | ä¿ç•™ HRESULT ç­¾å | true |
| `BestFitMapping` | bool | Unicodeâ†’ANSI æœ€ä½³æ˜ å°„ | false |
| `ThrowOnUnmappableChar` | bool | ä¸å¯æ˜ å°„å­—ç¬¦æŠ›å¼‚å¸¸ | false |

### 7.2 CharSet å­—ç¬¦é›†

| å€¼ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|-----|------|---------|
| **Ansi** | ANSI å­—ç¬¦ç¼–ç  | ä¼ ç»Ÿ C/C++ |
| **Unicode** | UTF-16 ç¼–ç  | .NET / Windows API |
| **Auto** | å¹³å°è‡ªåŠ¨é€‰æ‹© | è·¨å¹³å°ä»£ç  |

---

## å…«ã€å†…å­˜ç®¡ç†ä¸å°é€

### 8.1 æ‰˜ç®¡ä¸éæ‰˜ç®¡å†…å­˜å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å†…å­˜å¸ƒå±€å¯¹æ¯”                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  æ‰˜ç®¡å†…å­˜ (Managed Memory)           éæ‰˜ç®¡å†…å­˜ (Unmanaged Memory)         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  GC Heap                â”‚       â”‚  C/C++ Heap             â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”â”‚         â”‚
â”‚  â”‚  â”‚ obj1â”‚ â”‚ obj2â”‚ â”‚ obj3â”‚â”‚       â”‚  â”‚ptr1 â”‚ â”‚ptr2 â”‚ â”‚ptr3 â”‚â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜â”‚       â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜â”‚         â”‚
â”‚  â”‚                         â”‚       â”‚                         â”‚         â”‚
â”‚  â”‚  è‡ªåŠ¨åƒåœ¾å›æ”¶            â”‚       â”‚  æ‰‹åŠ¨é‡Šæ”¾ (free/delete)  â”‚         â”‚
â”‚  â”‚  å†…å­˜å¯ç§»åŠ¨              â”‚       â”‚  å†…å­˜ä½ç½®å›ºå®š            â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                         â”‚
â”‚  âš ï¸ é‡è¦: éæ‰˜ç®¡å†…å­˜ä¸æ‰˜ç®¡å†…å­˜ä¸èƒ½ç›´æ¥äº’æ¢                               â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 å¯ç›´æ¥å¤åˆ¶çš„ç±»å‹ (Blittable Types)

| ç±»åˆ« | ç±»å‹ |
|-----|------|
| **æœ‰ç¬¦å·æ•´æ•°** | sbyte, short, int, long |
| **æ— ç¬¦å·æ•´æ•°** | byte, ushort, uint, ulong |
| **æµ®ç‚¹æ•°** | single, double |
| **æŒ‡é’ˆ** | IntPtr, UIntPtr |
| **Blittable ç±»å‹çš„æ•°ç»„** | byte[], int[], float[] |

> ğŸ’¡ **æ€§èƒ½å»ºè®®**ï¼šå°½é‡ä½¿ç”¨ blittable ç±»å‹ï¼Œé¿å…æ•°æ®å¤åˆ¶

---

## ä¹ã€éæ‰˜ç®¡å†…å­˜é‡Šæ”¾

### 9.1 å†…å­˜åˆ†é…æ–¹å¼

| æ–¹å¼ | åˆ†é…å‡½æ•° | é‡Šæ”¾å‡½æ•° | .NET å…¼å®¹ |
|-----|---------|---------|-----------|
| **C è¯­è¨€** | `malloc` | `free` | âŒ ä¸è‡ªåŠ¨é‡Šæ”¾ |
| **C++ è¯­è¨€** | `new` | `delete` | âŒ ä¸è‡ªåŠ¨é‡Šæ”¾ |
| **COM ç»„ä»¶** | `CoTaskMemAlloc` | `CoTaskMemFree` | âœ… å°é€å™¨è‡ªåŠ¨é‡Šæ”¾ |

### 9.2 æ­£ç¡®çš„å†…å­˜é‡Šæ”¾æ–¹å¼

```csharp
// âŒ é”™è¯¯ç¤ºä¾‹: ä½¿ç”¨ malloc åˆ†é…ä½†è¿”å› string
[DllImport("NativeLib.dll",
    CallingConvention = CallingConvention.Cdecl,
    CharSet = CharSet.Unicode)]
static extern string GetStringMalloc();
// å°é€å™¨ä¼šå°è¯•ç”¨ CoTaskMemFree é‡Šæ”¾ â†’ å†…å­˜æ³„æ¼

// âœ… æ­£ç¡®æ–¹å¼ 1: ä½¿ç”¨ CoTaskMemAlloc
[DllImport("NativeLib.dll",
    CallingConvention = CallingConvention.Cdecl,
    CharSet = CharSet.Unicode)]
static extern string GetStringCoTaskMem();

// âœ… æ­£ç¡®æ–¹å¼ 2: è¿”å› IntPtr å¹¶æ‰‹åŠ¨é‡Šæ”¾
[DllImport("NativeLib.dll",
    CallingConvention = CallingConvention.Cdecl,
    CharSet = CharSet.Unicode)]
static extern IntPtr GetStringMalloc();

[DllImport("NativeLib.dll",
    CallingConvention = CallingConvention.Cdecl)]
static extern void FreeMemory(IntPtr p);

public void GetStringAndFree()
{
    IntPtr ptr = GetStringMalloc();
    string str = Marshal.PtrToStringUni(ptr);
    FreeMemory(ptr);  // æ‰‹åŠ¨é‡Šæ”¾
}
```

---

## åã€åŠ¨æ€è°ƒç”¨ (é«˜çº§)

### 10.1 åŠ¨æ€åŠ è½½ DLL

```csharp
using System;
using System.Runtime.InteropServices;

public class DynamicPInvoke
{
    // å§”æ‰˜å®šä¹‰
    [UnmanagedFunctionPointer(CallingConvention.StdCall)]
    public delegate int AddDelegate(int x, int y);

    // Win32 API
    [DllImport("kernel32.dll", CharSet = CharSet.Auto, SetLastError = true)]
    public static extern IntPtr LoadLibrary(string lpFileName);

    [DllImport("kernel32.dll", CharSet = CharSet.Ansi, SetLastError = true)]
    public static extern IntPtr GetProcAddress(IntPtr hModule, string lpProcName);

    [DllImport("kernel32.dll", SetLastError = true)]
    public static extern bool FreeLibrary(IntPtr hModule);

    public static int DynamicCall(string dllPath, string functionName)
    {
        // åŠ è½½ DLL
        IntPtr dllAddr = LoadLibrary(dllPath);
        if (dllAddr == IntPtr.Zero)
            throw new Exception($"æ— æ³•åŠ è½½ DLL: {dllPath}");

        try
        {
            // è·å–å‡½æ•°åœ°å€
            IntPtr procAddr = GetProcAddress(dllAddr, functionName);
            if (procAddr == IntPtr.Zero)
                throw new Exception($"æ‰¾ä¸åˆ°å‡½æ•°: {functionName}");

            // è½¬æ¢ä¸ºå§”æ‰˜
            AddDelegate addFunc = (AddDelegate)Marshal
                .GetDelegateForFunctionPointer(procAddr, typeof(AddDelegate));

            // è°ƒç”¨
            return addFunc(10, 20);
        }
        finally
        {
            // é‡Šæ”¾ DLL
            FreeLibrary(dllAddr);
        }
    }
}
```

---

## åä¸€ã€unsafe ä»£ç ä¸æŒ‡é’ˆ

### 11.1 unsafe å…³é”®å­—

```csharp
// unsafe ä»£ç å—
public unsafe void UnsafeExample()
{
    int value = 42;
    int* ptr = &value;  // å£°æ˜æŒ‡é’ˆ

    *ptr = 100;  // è§£å¼•ç”¨
}

// unsafe æ–¹æ³•
public unsafe void* UnsafeMethod(int* input)
{
    return input;
}

// unsafe ç±»
public unsafe unsafe class UnsafeClass
{
    public int* PointerField;
}
```

### 11.2 fixed è¯­å¥

```csharp
public void FixedExample()
{
    int[] array = { 1, 2, 3, 4, 5 };

    // fixed å›ºå®šå†…å­˜ä½ç½®ï¼Œé˜²æ­¢ GC ç§»åŠ¨
    fixed (int* ptr = array)
    {
        for (int i = 0; i < 5; i++)
        {
            *(ptr + i) = *(ptr + i) * 2;  // ç›´æ¥æ“ä½œæŒ‡é’ˆ
        }
    }
}
```

### 11.3 stackalloc æ ˆåˆ†é…

```csharp
public void StackAllocExample()
{
    // åœ¨æ ˆä¸Šåˆ†é…æ•°ç»„
    byte* bytes = stackalloc byte[42];

    // åˆå§‹åŒ–
    for (int i = 0; i < 42; i++)
    {
        bytes[i] = (byte)i;
    }

    // âš ï¸ æ³¨æ„: stackalloc åˆ†é…çš„å†…å­˜åœ¨æ–¹æ³•è¿”å›åè‡ªåŠ¨é‡Šæ”¾
    // æ— æ³•æ‰‹åŠ¨é‡Šæ”¾ï¼Œä¸é€‚åˆå¤§å—å†…å­˜
}
```

### 11.4 æŒ‡é’ˆç±»å‹æœ‰æ•ˆæ€§

| ç±»å‹ | æ˜¯å¦æœ‰æ•ˆ | è¯´æ˜ |
|-----|---------|------|
| åŸºæœ¬æ•°å€¼ç±»å‹ | âœ… | byte, short, int, long, float, double, bool, char |
| æšä¸¾ | âœ… | enum çš„åº•å±‚ç±»å‹ |
| æŒ‡é’ˆç±»å‹ | âœ… | int**, void*** |
| void* | âœ… | æŒ‡å‘æœªçŸ¥ç±»å‹ |
| å¼•ç”¨ç±»å‹ | âŒ | class, string, object |
| æ³›å‹ç±»å‹ | âŒ | T<T> |

---

## åäºŒã€å®Œæ•´è°ƒç”¨æµç¨‹

### 12.1 æ‰˜ç®¡è°ƒç”¨éæ‰˜ç®¡è¯¦ç»†æ­¥éª¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 P/Invoke å®Œæ•´æ‰§è¡Œæµç¨‹ (13æ­¥)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â‘  è°ƒç”¨ LoadLibrary åŠ è½½éæ‰˜ç®¡ DLL åˆ°å†…å­˜                                â”‚
â”‚                                                                         â”‚
â”‚  â‘¡ è°ƒç”¨ GetProcAddress è·å–å‡½æ•°åœ°å€                                      â”‚
â”‚                                                                         â”‚
â”‚  â‘¢ ç”Ÿæˆ DllImport å­˜æ ¹ (Stub)                                            â”‚
â”‚                                                                         â”‚
â”‚  â‘£ å‹å…¥è¢«è°ƒç”¨æ–¹ä¿å­˜çš„å¯„å­˜å™¨                                              â”‚
â”‚                                                                         â”‚
â”‚  â‘¤ åˆ›å»º DllImport å¸§ (Frame) å¹¶å‹å…¥å †æ ˆå¸§ (Stack Frame)                  â”‚
â”‚                                                                         â”‚
â”‚  â‘¥ é¢„ç½®æ¸…é™¤åˆ—è¡¨ (ç”¨äºä¸´æ—¶å†…å­˜å¿«é€Ÿé‡Šæ”¾)                                   â”‚
â”‚                                                                         â”‚
â”‚  â‘¦ å°é€å‚æ•° (å¯èƒ½åˆ†é…å†…å­˜)                                               â”‚
â”‚                                                                         â”‚
â”‚  â‘§ å°† GC æ¨¡å¼ä»åä½œå¼æ”¹ä¸ºæŠ¢å å¼                                         â”‚
â”‚                                                                         â”‚
â”‚  â‘¨ åŠ è½½ç›®æ ‡åœ°å€å¹¶æ‰§è¡Œè°ƒç”¨                                               â”‚
â”‚                                                                         â”‚
â”‚  â‘© è°ƒç”¨ GetLastError å¹¶å­˜å‚¨åˆ° TLS (å¦‚æœ SetLastError=true)              â”‚
â”‚                                                                         â”‚
â”‚  â‘ª å°† GC æ¨¡å¼æ”¹å›åä½œå¼                                                  â”‚
â”‚                                                                         â”‚
â”‚  â‘« æ£€æŸ¥ HRESULT å¹¶æŠ›å‡ºå¼‚å¸¸ (å¦‚æœ PreserveSig=false ä¸”å¤±è´¥)               â”‚
â”‚                                                                         â”‚
â”‚  â‘¬ å›ä¼  out/ref å‚æ•°ï¼Œæ¢å¤æ ˆæŒ‡é’ˆ                                          â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åä¸‰ã€æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 13.1 å°é€ä¼˜åŒ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å°é€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â‘  ä½¿ç”¨ ExactSpelling = true                                            â”‚
â”‚     â””â”€â”€ é¿å…åç§°ä¿®é¥°æŸ¥æ‰¾ï¼Œæé«˜ DLL å‡½æ•°æœç´¢æ•ˆç‡                          â”‚
â”‚                                                                         â”‚
â”‚  â‘¡ ä½¿ç”¨ Blittable ç±»å‹                                                   â”‚
â”‚     â””â”€â”€ é¿å…æ•°æ®å¤åˆ¶ï¼Œå®ç°å†…å­˜é”å®š                                       â”‚
â”‚                                                                         â”‚
â”‚  â‘¢ é¿å…å¼•ç”¨ç±»å‹å‚æ•°                                                      â”‚
â”‚     â””â”€â”€ åŸºç¡€ç±»å‹ (int, float) æ¯”ç±»å¯¹è±¡æ›´å¿«                               â”‚
â”‚                                                                         â”‚
â”‚  â‘£ é¿å… out/ref å‚æ•°                                                     â”‚
â”‚     â””â”€â”€ ä½¿å†…å­˜é”å®šæˆä¸ºå¯èƒ½                                               â”‚
â”‚                                                                         â”‚
â”‚  â‘¤ ä½¿ç”¨ IntPtr è€Œé string                                               â”‚
â”‚     â””â”€â”€ é¿å…ä¸å¿…è¦çš„å­—ç¬¦ä¸²å°é€                                           â”‚
â”‚                                                                         â”‚
â”‚  â‘¥ æ‰¹é‡å¤„ç†æ•°æ®                                                          â”‚
â”‚     â””â”€â”€ å‡å°‘äº’æ“ä½œè°ƒç”¨æ¬¡æ•°                                               â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 13.2 å†…å­˜é”å®šæ¡ä»¶

æ‰˜ç®¡å†…å­˜å¯ä»¥è¢«é”å®šï¼ˆæ— éœ€å¤åˆ¶ï¼‰éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

1. **å¿…é¡»æ˜¯æ‰˜ç®¡ä»£ç è°ƒç”¨éæ‰˜ç®¡ä»£ç **
2. **æ•°æ®ç±»å‹å¿…é¡»æ˜¯ Blittable ç±»å‹**
3. **ä¸èƒ½ä½¿ç”¨ out æˆ– ref å‚æ•°**
4. **è°ƒç”¨æ–¹å’Œè¢«è°ƒç”¨æ–¹åœ¨åŒä¸€çº¿ç¨‹å•å…ƒ**

---

## åå››ã€ToLua ä¸­çš„åº”ç”¨

### 14.1 LuaDLL.cs ç»“æ„

```csharp
// ToLua æ¡†æ¶é€šè¿‡ LuaDLL.cs å®ç° C# ä¸ Lua C/C++ ä»£ç çš„äº’æ“ä½œ

public partial class LuaDLL
{
    #if UNITY_IOS && !UNITY_EDITOR
    internal const string LUA_DLL = "__Internal";  // iOS å¹³å°
    #elif UNITY_ANDROID && !UNITY_EDITOR
    internal const string LUA_DLL = "tolua";       // Android å¹³å°
    #else
    internal const string LUA_DLL = "tolua";       // å…¶ä»–å¹³å°
    #endif

    // Lua çŠ¶æ€æœºæ“ä½œ
    [DllImport(LUA_DLL, CallingConvention = CallingConvention.Cdecl)]
    public static extern IntPtr lua_open();

    [DllImport(LUA_DLL, CallingConvention = CallingConvention.Cdecl)]
    public static extern void lua_close(IntPtr L);

    [DllImport(LUA_DLL, CallingConvention = CallingConvention.Cdecl)]
    public static extern void lua_getfield(IntPtr L, int idx, string name);

    // ... æ›´å¤š Lua API ç»‘å®š
}
```

### 14.2 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ToLua äº’æ“ä½œæ¶æ„                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    DllImport    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  LuaState.cs    â”‚ ==============> â”‚  LuaDLL.cs      â”‚               â”‚
â”‚  â”‚  (C# å°è£…å±‚)     â”‚                â”‚  (P/Invoke å±‚)   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚       â–²                                    â”‚                         â”‚
â”‚       â”‚                                    â”‚                         â”‚
â”‚       â”‚ ç”¨æˆ·è°ƒç”¨                           â”‚ å¹³å°è°ƒç”¨                 â”‚
â”‚       â”‚                                    â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  C# ä¸šåŠ¡ä»£ç      â”‚                â”‚  tolua.dll      â”‚               â”‚
â”‚  â”‚  (æ¸¸æˆé€»è¾‘)      â”‚                â”‚  tolua.so       â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚  (C/C++ å®ç°)   â”‚               â”‚
â”‚                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åäº”ã€æ€»ç»“

| ä¸»é¢˜ | è¦ç‚¹ |
|-----|------|
| **P/Invoke** | æ‰˜ç®¡ä»£ç è°ƒç”¨éæ‰˜ç®¡ DLL çš„æ ‡å‡†æ–¹å¼ |
| **C++ Interop** | æºç çº§äº’æ“ä½œï¼Œç¼–è¯‘åˆ°åŒä¸€ç¨‹åºé›† |
| **COM Interop** | Windows å¹³å°ç»„ä»¶äº’æ“ä½œ |
| **DllImport** | å£°æ˜éæ‰˜ç®¡å‡½æ•°å…¥å£ç‚¹ |
| **Marshal** | æ•°æ®å°é€ä¸æŒ‡é’ˆæ“ä½œ |
| **unsafe/fixed** | ç›´æ¥æ“ä½œéæ‰˜ç®¡å†…å­˜ |
| **å›è°ƒ** | é€šè¿‡å§”æ‰˜å®ç° C++ è°ƒç”¨ C# |
| **æ€§èƒ½ä¼˜åŒ–** | ä½¿ç”¨ Blittable ç±»å‹ï¼Œé¿å…å°é€å¼€é”€ |

> ğŸ’¡ **æœ€ä½³å®è·µ**ï¼š
> - éµå¾ªè§„èŒƒï¼Œé¿å…"éªšæ“ä½œ"
> - ä½¿ç”¨ blittable ç±»å‹æé«˜æ€§èƒ½
> - æ˜ç¡®å†…å­˜ç®¡ç†è´£ä»»
> - é˜…è¯»å®˜æ–¹æ–‡æ¡£å’Œæƒå¨ä¹¦ç±

---

**è½¬è½½è¯·æ³¨æ˜æ¥æº**ï¼Œæ¬¢è¿å¯¹æ–‡ç« ä¸­çš„å¼•ç”¨æ¥æºè¿›è¡Œè€ƒè¯ï¼Œæ¬¢è¿æŒ‡å‡ºä»»ä½•æœ‰é”™è¯¯æˆ–ä¸å¤Ÿæ¸…æ™°çš„è¡¨è¾¾ã€‚å¯ä»¥åœ¨ä¸‹é¢è¯„è®ºåŒºè¯„è®ºï¼Œä¹Ÿå¯ä»¥é‚®ä»¶è‡³ 1487842110@qq.com
