---
title: "Unity èŠ‚ç‚¹ç¼–è¾‘å™¨å®Œå…¨æŒ‡å—ï¼šä»é›¶å®ç°å¯è§†åŒ–ç¼–ç¨‹ç³»ç»Ÿ"
date: 2020/05/08
categories: [æŠ€æœ¯æ–‡ç« , Unityå¼€å‘]
tags: [Unity, UnityEditor, EditorWindow, èŠ‚ç‚¹ç¼–è¾‘å™¨, GraphView, å¯è§†åŒ–ç¼–ç¨‹]
image: /images/unity-node-editor-banner.jpg
---

# ğŸ”— Unity èŠ‚ç‚¹ç¼–è¾‘å™¨å®Œå…¨æŒ‡å—ï¼šä»é›¶å®ç°å¯è§†åŒ–ç¼–ç¨‹ç³»ç»Ÿ

> ğŸ’¡ **å¯è§†åŒ–ç¼–ç¨‹çš„å¨åŠ›**ï¼š
> - æƒ³å®ç°ç±»ä¼¼è“å›¾ã€Shader Graph çš„èŠ‚ç‚¹å¼ç¼–è¾‘å™¨ï¼Ÿ
> - GraphView æ–° API æ€ä¹ˆä½¿ç”¨ï¼Œæœ‰å“ªäº›å‘ï¼Ÿ
> - å¦‚ä½•å®ç°èŠ‚ç‚¹æ‹–æ‹½ã€è¿çº¿ã€ç«¯å£ç­‰æ ¸å¿ƒåŠŸèƒ½ï¼Ÿ
> - ä»é›¶å¼€å§‹åšä¸€ä¸ªå®Œæ•´çš„èŠ‚ç‚¹ç¼–è¾‘å™¨éœ€è¦å¤šä¹…ï¼Ÿ
>
> **è¿™ç¯‡æ–‡ç« ï¼** å°†å¸¦ä½ ä»é›¶å¼€å§‹ï¼Œä½¿ç”¨ Unity GraphView å®ç°ä¸€ä¸ªå®Œæ•´çš„èŠ‚ç‚¹ç¼–è¾‘å™¨ï¼

## ä¸€ã€èŠ‚ç‚¹ç¼–è¾‘å™¨æ¦‚è¿°

èŠ‚ç‚¹ç¼–è¾‘å™¨æ˜¯ä¸€ç§é€šè¿‡è¿æ¥èŠ‚ç‚¹æ¥åˆ›å»ºé€»è¾‘çš„å¯è§†åŒ–ç¼–ç¨‹å·¥å…·ã€‚

### 1.1 èŠ‚ç‚¹ç¼–è¾‘å™¨çš„åº”ç”¨

| åº”ç”¨ | æè¿° | ç¤ºä¾‹ |
|------|------|------|
| **æ¸¸æˆé€»è¾‘** | å¯è§†åŒ–ç¼–ç¨‹ | Unreal Blueprint, Unity Visual Scripting |
| **ç€è‰²å™¨** | å›¾å½¢åŒ–ç€è‰²å™¨ç¼–è¾‘ | Shader Graph, Amplify Shader |
| **åŠ¨ç”»** | åŠ¨ç”»çŠ¶æ€æœº | Animator Controller |
| **AI è¡Œä¸º** | è¡Œä¸ºæ ‘ç¼–è¾‘ | Behavior Designer |
| **å¯¹è¯ç³»ç»Ÿ** | å¯¹è¯æµç¨‹ç¼–è¾‘ | yarn, Articy |

### 1.2 åŸºæœ¬æ„æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    èŠ‚ç‚¹ç¼–è¾‘å™¨ç•Œé¢                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    è¿çº¿      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   èŠ‚ç‚¹ A      â”‚ â•â•â•â•â•â•â•â•â•â•â•>â”‚   èŠ‚ç‚¹ B      â”‚           â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚             â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚           â”‚
â”‚  â”‚  â”‚ è¾“å…¥ç«¯å£ â”‚  â”‚             â”‚  â”‚ è¾“å…¥ç«¯å£ â”‚  â”‚           â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚             â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚           â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚             â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚           â”‚
â”‚  â”‚  â”‚è¾“å‡ºç«¯å£ â”‚  â”‚             â”‚  â”‚è¾“å‡ºç«¯å£ â”‚  â”‚           â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚             â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                            â”‚
â”‚  èŠ‚ç‚¹ = æ•°æ®å¤„ç†å•å…ƒ                                       â”‚
â”‚  ç«¯å£ = æ•°æ®è¾“å…¥/è¾“å‡ºç‚¹                                    â”‚
â”‚  è¿çº¿ = æ•°æ®æµå‘                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€ä½¿ç”¨ GraphViewï¼ˆUnity 2019+ï¼‰

ä» Unity 2019 å¼€å§‹ï¼ŒUnity å¼•å…¥äº† `GraphView` æ¡†æ¶ï¼Œä¸“é—¨ç”¨äºåˆ›å»ºèŠ‚ç‚¹ç¼–è¾‘å™¨ã€‚

### 2.1 åŸºæœ¬ç»“æ„

```csharp
using UnityEngine;
using UnityEditor;
using UnityEditor.Experimental.GraphView;

public class SimpleNodeEditor : EditorWindow
{
    private SimpleGraphView graphView;

    [MenuItem("Tools/Node Editor")]
    public static void ShowWindow()
    {
        var window = GetWindow<SimpleNodeEditor>();
        window.titleContent = new GUIContent("èŠ‚ç‚¹ç¼–è¾‘å™¨");
        window.Show();
    }

    void OnEnable()
    {
        // åˆ›å»º GraphView
        graphView = new SimpleGraphView()
        {
            style = { flexGrow = 1 }
        };

        // æ·»åŠ åˆ°çª—å£
        rootVisualElement.Add(graphView);
    }
}
```

### 2.2 åˆ›å»ºè‡ªå®šä¹‰ GraphView

```csharp
using UnityEditor.Experimental.GraphView;

public class SimpleGraphView : GraphView
{
    public SimpleGraphView()
    {
        // è®¾ç½®ç¼©æ”¾å’Œæ‹–æ‹½
        SetupZoom(ContentZoomer.DefaultMinScale, ContentZoomer.DefaultMaxScale);

        // æ·»åŠ èƒŒæ™¯ç½‘æ ¼
        var grid = new GridBackground();
        Insert(0, grid);
        grid.StretchToParentSize();

        // æ·»åŠ æ ·å¼
        AddStyles();
    }

    private void AddStyles()
    {
        // åŠ è½½ USS æ ·å¼æ–‡ä»¶
        var style = StyleSheet.Load("SimpleNodeEditor.uss");
        styleSheets.Add(style);
    }

    // è·å–å¯å…¼å®¹çš„ç«¯å£
    public override List<Port> GetCompatiblePorts(Port startPort, NodeAdapter nodeAdapter)
    {
        var compatiblePorts = new List<Port>();

        // éå†æ‰€æœ‰ç«¯å£
        ports.ForEach((port) =>
        {
            // ä¸èƒ½è¿æ¥åˆ°è‡ªå·±
            if (startPort == port) return;

            // ä¸èƒ½è¿æ¥åˆ°åŒä¸€èŠ‚ç‚¹çš„å…¶ä»–ç«¯å£
            if (startPort.node == port.node) return;

            // è¾“å…¥åªèƒ½è¿è¾“å‡ºï¼Œè¾“å‡ºåªèƒ½è¿è¾“å…¥
            if (startPort.direction == port.direction) return;

            // ç±»å‹å¿…é¡»åŒ¹é…
            if (startPort.portType != port.portType) return;

            compatiblePorts.Add(port);
        });

        return compatiblePorts;
    }
}
```

---

## ä¸‰ã€åˆ›å»ºèŠ‚ç‚¹

### 3.1 èŠ‚ç‚¹åŸºç±»

```csharp
using UnityEditor.Experimental.GraphView;

public class BaseNode : Node
{
    public string GUID { get; protected set; }
    public string NodeName { get; protected set; }

    public BaseNode()
    {
        GUID = Guid.NewGuid().ToString();
    }

    // åˆ›å»ºè¾“å…¥ç«¯å£
    protected Port CreateInputPort(string portName, System.Type type)
    {
        var port = InstantiatePort(Orientation.Horizontal, Direction.Input, Capacity.Multi, type);
        port.portName = portName;
        inputContainer.Add(port);
        return port;
    }

    // åˆ›å»ºè¾“å‡ºç«¯å£
    protected Port CreateOutputPort(string portName, System.Type type)
    {
        var port = InstantiatePort(Orientation.Horizontal, Direction.Output, Capacity.Multi, type);
        port.portName = portName;
        outputContainer.Add(port);
        return port;
    }
}
```

### 3.2 å…·ä½“èŠ‚ç‚¹å®ç°

```csharp
// æ•°å­¦è¿ç®—èŠ‚ç‚¹
public class MathNode : BaseNode
{
    private Port inputPortA;
    private Port inputPortB;
    private Port outputPort;

    public MathNode()
    {
        NodeName = "Math (Add)";
        title = NodeName;

        // åˆ›å»ºè¾“å…¥ç«¯å£
        inputPortA = CreateInputPort("A", typeof(float));
        inputPortB = CreateInputPort("B", typeof(float));

        // åˆ›å»ºè¾“å‡ºç«¯å£
        outputPort = CreateOutputPort("Result", typeof(float));

        // æ·»åŠ é€‰æ‹©æ¡†
        var operationEnum = new System.EnumField(MathOperation.Add);
        operationEnum.SetValueWithoutNotify(MathOperation.Add);
        mainContainer.Add(operationEnum);

        RefreshExpandedState();
        RefreshPorts();
    }

    public enum MathOperation
    {
        Add,
        Subtract,
        Multiply,
        Divide
    }
}

// æ•°å€¼èŠ‚ç‚¹
public class NumberNode : BaseNode
{
    private Port outputPort;
    private TextField valueField;

    public float Value { get; set; } = 0f;

    public NumberNode()
    {
        NodeName = "Number";
        title = NodeName;

        // åˆ›å»ºè¾“å‡ºç«¯å£
        outputPort = CreateOutputPort("Value", typeof(float));

        // åˆ›å»ºæ•°å€¼è¾“å…¥æ¡†
        valueField = new TextField("Value")
        {
            value = Value.ToString()
        };
        valueField.RegisterValueChangedCallback(evt =>
        {
            if (float.TryParse(evt.newValue, out float newValue))
            {
                Value = newValue;
            }
        });

        mainContainer.Add(valueField);

        RefreshExpandedState();
        RefreshPorts();
    }
}

// è¾“å‡ºèŠ‚ç‚¹
public class OutputNode : BaseNode
{
    private Port inputPort;
    private TextField resultField;

    public OutputNode()
    {
        NodeName = "Output";
        title = NodeName;

        // åˆ›å»ºè¾“å…¥ç«¯å£
        inputPort = CreateInputPort("Input", typeof(float));

        // åˆ›å»ºç»“æœæ˜¾ç¤ºæ¡†
        resultField = new TextField("Result")
        {
            isReadOnly = true,
            value = "0"
        };
        mainContainer.Add(resultField);

        RefreshExpandedState();
        RefreshPorts();
    }
}
```

### 3.3 èŠ‚ç‚¹åˆ›å»ºå™¨

```csharp
using UnityEditor.Experimental.GraphView;

public class NodeCreationProvider : ScriptableObject, ISearchWindowProvider
{
    private GraphView graphView;
    private EditorWindow window;

    public void Initialize(GraphView graphView, EditorWindow window)
    {
        this.graphView = graphView;
        this.window = window;
    }

    public List<SearchTreeEntry> CreateSearchTree(SearchWindowContext context)
    {
        var tree = new List<SearchTreeEntry>
        {
            new SearchTreeGroupEntry(new GUIContent("åˆ›å»ºèŠ‚ç‚¹")),
            new SearchTreeEntry(new GUIContent("æ•°å€¼èŠ‚ç‚¹"))
            {
                level = 1,
                userData = new NumberNode()
            },
            new SearchTreeEntry(new GUIContent("æ•°å­¦è¿ç®—"))
            {
                level = 1,
                userData = new MathNode()
            },
            new SearchTreeEntry(new GUIContent("è¾“å‡ºèŠ‚ç‚¹"))
            {
                level = 1,
                userData = new OutputNode()
            }
        };
        return tree;
    }

    public bool OnSelectEntry(SearchTreeEntry entry, SearchWindowContext context)
    {
        if (entry.userData is BaseNode node)
        {
            // è·å–é¼ æ ‡ä½ç½®
            var mousePos = window.rootVisualElement.ChangeCoordinatesTo(
                window.rootVisualElement.parent,
                context.screenMousePosition - window.position.position
            );

            // è®¾ç½®èŠ‚ç‚¹ä½ç½®
            node.SetPosition(new Rect(mousePos, Vector2.zero));

            // æ·»åŠ åˆ° GraphView
            graphView.AddElement(node);
            return true;
        }
        return false;
    }
}
```

---

## å››ã€å®Œæ•´ GraphView å®ç°

```csharp
using UnityEngine;
using UnityEditor;
using UnityEditor.Experimental.GraphView;
using System.Linq;

public class SimpleGraphView : GraphView
{
    private NodeCreationProvider nodeCreationProvider;

    public SimpleGraphView(EditorWindow window)
    {
        // è®¾ç½®ç¼©æ”¾
        SetupZoom(ContentZoomer.DefaultMinScale, ContentZoomer.DefaultMaxScale);

        // æ·»åŠ èƒŒæ™¯ç½‘æ ¼
        var grid = new GridBackground();
        Insert(0, grid);
        grid.StretchToParentSize();

        // æ·»åŠ èŠ‚ç‚¹åˆ›å»ºæä¾›è€…
        nodeCreationProvider = ScriptableObject.CreateInstance<NodeCreationProvider>();
        nodeCreationProvider.Initialize(this, window);

        // æ·»åŠ æœç´¢çª—å£
        var searchWindow = ScriptableObject.CreateInstance<SearchWindow>();
        searchWindow.context = nodeCreationProvider;
        searchWindow.OnSelectEntryHandler = nodeCreationProvider.OnSelectEntry;

        // æ³¨å†Œå³é”®èœå•å›è°ƒ
        nodeCreationRequest = context =>
        {
            searchWindow.Open(
                context.screenMousePosition - window.position.position,
                null,
                this,
                nodeCreationProvider
            );
        };

        // æ·»åŠ æ ·å¼
        AddStyles();

        // æ·»åŠ ä¸€äº›åˆå§‹èŠ‚ç‚¹
        AddInitialNodes();
    }

    private void AddStyles()
    {
        var style = StyleSheet.Load("SimpleNodeEditor.uss");
        if (style != null)
        {
            styleSheets.Add(style);
        }
    }

    private void AddInitialNodes()
    {
        // åˆ›å»ºä¸€ä¸ªæ•°å€¼èŠ‚ç‚¹
        var numberNode = new NumberNode
        {
            Value = 10f
        };
        numberNode.SetPosition(new Rect(100, 100, 100, 100));
        AddElement(numberNode);

        // åˆ›å»ºä¸€ä¸ªè¾“å‡ºèŠ‚ç‚¹
        var outputNode = new OutputNode();
        outputNode.SetPosition(new Rect(400, 100, 100, 100));
        AddElement(outputNode);
    }

    public override List<Port> GetCompatiblePorts(Port startPort, NodeAdapter nodeAdapter)
    {
        var compatiblePorts = new List<Port>();

        ports.ForEach(port =>
        {
            if (startPort == port) return;
            if (startPort.node == port.node) return;
            if (startPort.direction == port.direction) return;

            compatiblePorts.Add(port);
        });

        return compatiblePorts;
    }
}
```

---

## äº”ã€èŠ‚ç‚¹æ•°æ®åºåˆ—åŒ–

### 5.1 èŠ‚ç‚¹æ•°æ®ç±»

```csharp
using System;
using UnityEngine;

[Serializable]
public class NodeData
{
    public string guid;
    public string typeName;
    public Vector2 position;
    public string jsonData;
}

[Serializable]
public class EdgeData
{
    public string sourceNodeGuid;
    public string sourcePortName;
    public string targetNodeGuid;
    public string targetPortName;
}

[Serializable]
public class GraphData
{
    public NodeData[] nodes;
    public EdgeData[] edges;
}
```

### 5.2 åºåˆ—åŒ–/ååºåˆ—åŒ–

```csharp
using UnityEngine;
using UnityEditor;
using System.IO;
using UnityEditor.Experimental.GraphView;

public partial class SimpleGraphView : GraphView
{
    public void SaveGraph(string path)
    {
        var graphData = new GraphData();

        // æ”¶é›†èŠ‚ç‚¹æ•°æ®
        var nodes = graphElements.ToList().OfType<BaseNode>().ToList();
        graphData.nodes = nodes.Select(node => new NodeData
        {
            guid = node.GUID,
            typeName = node.GetType().Name,
            position = node.GetPosition().position,
            jsonData = JsonUtility.ToJson(node)
        }).ToArray();

        // æ”¶é›†è¿çº¿æ•°æ®
        var edges = graphElements.ToList().OfType<Edge>().ToList();
        graphData.edges = edges.Select(edge => new EdgeData
        {
            sourceNodeGuid = (edge.output.node as BaseNode)?.GUID,
            sourcePortName = edge.output.portName,
            targetNodeGuid = (edge.input.node as BaseNode)?.GUID,
            targetPortName = edge.input.portName
        }).ToArray();

        // å†™å…¥æ–‡ä»¶
        var json = JsonUtility.ToJson(graphData, true);
        File.WriteAllText(path, json);

        Debug.Log($"Graph saved to: {path}");
    }

    public void LoadGraph(string path)
    {
        if (!File.Exists(path))
        {
            Debug.LogWarning($"Graph file not found: {path}");
            return;
        }

        // è¯»å–æ–‡ä»¶
        var json = File.ReadAllText(path);
        var graphData = JsonUtility.FromJson<GraphData>(json);

        // æ¸…ç©ºå½“å‰å›¾
        DeleteElements(graphElements.ToList());

        // é‡å»ºèŠ‚ç‚¹
        foreach (var nodeData in graphData.nodes)
        {
            var node = CreateNodeFromType(nodeData.typeName);
            if (node != null)
            {
                node.GUID = nodeData.guid;
                node.SetPosition(new Rect(nodeData.position, Vector2.zero));
                JsonUtility.FromJsonOverwrite(nodeData.jsonData, node);
                AddElement(node);
            }
        }

        // é‡å»ºè¿çº¿
        foreach (var edgeData in graphData.edges)
        {
            var sourceNode = graphElements.ToList().OfType<BaseNode>()
                .FirstOrDefault(n => n.GUID == edgeData.sourceNodeGuid);
            var targetNode = graphElements.ToList().OfType<BaseNode>()
                .FirstOrDefault(n => n.GUID == edgeData.targetNodeGuid);

            if (sourceNode != null && targetNode != null)
            {
                var sourcePort = sourceNode.outputContainer.Children()
                    .OfType<Port>().FirstOrDefault(p => p.portName == edgeData.sourcePortName);
                var targetPort = targetNode.inputContainer.Children()
                    .OfType<Port>().FirstOrDefault(p => p.portName == edgeData.targetPortName);

                if (sourcePort != null && targetPort != null)
                {
                    var edge = sourcePort.ConnectTo(targetPort);
                    AddElement(edge);
                }
            }
        }

        Debug.Log($"Graph loaded from: {path}");
    }

    private BaseNode CreateNodeFromType(string typeName)
    {
        switch (typeName)
        {
            case nameof(NumberNode):
                return new NumberNode();
            case nameof(MathNode):
                return new MathNode();
            case nameof(OutputNode):
                return new OutputNode();
            default:
                return null;
        }
    }
}
```

---

## å…­ã€USS æ ·å¼

åˆ›å»º `SimpleNodeEditor.uss` æ–‡ä»¶ï¼š

```uss
/* SimpleNodeEditor.uss */

/* èŠ‚ç‚¹æ ·å¼ */
.node {
    border-radius: 5px;
    border-width: 2px;
    border-color: #555;
    background-color: #333;
}

.node:hover {
    border-color: #888;
}

.node.selected {
    border-color: #4a90d9;
    background-color: #3a3a3a;
}

/* ç«¯å£æ ·å¼ */
.port {
    border-radius: 5px;
    border-width: 2px;
    border-color: #666;
    background-color: #444;
    width: 12px;
    height: 12px;
}

.port:hover {
    background-color: #666;
}

/* è¾“å…¥ç«¯å£ */
.port.input {
    border-color: #66d9ef;
}

/* è¾“å‡ºç«¯å£ */
.port.output {
    border-color: #f39c12;
}

/* è¿çº¿æ ·å¼ */
.edge {
    stroke-color: #999;
    stroke-width: 2px;
}

.edge:hover {
    stroke-color: #4a90d9;
    stroke-width: 3px;
}

/* æ–‡æœ¬æ ·å¼ */
TextField {
    border-color: #555;
    background-color: #222;
    color: #fff;
    font-size: 12px;
    border-radius: 3px;
    padding: 3px;
}

EnumField {
    border-color: #555;
    background-color: #222;
    color: #fff;
}
```

---

## ä¸ƒã€å®Œæ•´çª—å£å®ç°

```csharp
using UnityEngine;
using UnityEditor;
using UnityEditor.Experimental.GraphView;
using System.IO;

public class SimpleNodeEditor : EditorWindow
{
    private SimpleGraphView graphView;
    private Toolbar toolbar;

    [MenuItem("Tools/Node Editor")]
    public static void ShowWindow()
    {
        var window = GetWindow<SimpleNodeEditor>();
        window.titleContent = new GUIContent("èŠ‚ç‚¹ç¼–è¾‘å™¨");
        window.Show();
    }

    void OnEnable()
    {
        // åˆ›å»ºå·¥å…·æ 
        CreateToolbar();

        // åˆ›å»º GraphView
        graphView = new SimpleGraphView(this);
        graphView.StretchToParentSize();
        rootVisualElement.Add(graphView);
    }

    private void CreateToolbar()
    {
        toolbar = new Toolbar();

        // ä¿å­˜æŒ‰é’®
        var saveButton = new Button(() => SaveGraph())
        {
            text = "ä¿å­˜"
        };
        toolbar.Add(saveButton);

        // åŠ è½½æŒ‰é’®
        var loadButton = new Button(() => LoadGraph())
        {
            text = "åŠ è½½"
        };
        toolbar.Add(loadButton);

        // æ¸…ç©ºæŒ‰é’®
        var clearButton = new Button(() => graphView.DeleteElements(graphView.graphElements.ToList()))
        {
            text = "æ¸…ç©º"
        };
        toolbar.Add(clearButton);

        rootVisualElement.Add(toolbar);
    }

    private void SaveGraph()
    {
        var path = EditorUtility.SaveFilePanelInProject(
            "ä¿å­˜èŠ‚ç‚¹å›¾",
            "MyGraph",
            "json",
            "è¯·é€‰æ‹©ä¿å­˜ä½ç½®"
        );

        if (!string.IsNullOrEmpty(path))
        {
            graphView.SaveGraph(path);
        }
    }

    private void LoadGraph()
    {
        var path = EditorUtility.OpenFilePanel(
            "åŠ è½½èŠ‚ç‚¹å›¾",
            Application.dataPath,
            "json"
        );

        if (!string.IsNullOrEmpty(path))
        {
            // è½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„
            if (path.StartsWith(Application.dataPath))
            {
                path = "Assets" + path.Substring(Application.dataPath.Length);
            }
            graphView.LoadGraph(path);
        }
    }
}
```

---

## å…«ã€ä½¿ç”¨æ•ˆæœ

### 8.1 åˆ›å»ºèŠ‚ç‚¹

1. æ‰“å¼€ `Tools > Node Editor`
2. å³é”®ç‚¹å‡»ç©ºç™½åŒºåŸŸ
3. ä»æœç´¢çª—å£é€‰æ‹©è¦åˆ›å»ºçš„èŠ‚ç‚¹

### 8.2 è¿æ¥èŠ‚ç‚¹

1. ç‚¹å‡»è¾“å‡ºç«¯å£æ‹–åŠ¨åˆ°è¾“å…¥ç«¯å£
2. è‡ªåŠ¨åˆ›å»ºè¿æ¥çº¿

### 8.3 ç•Œé¢æ•ˆæœ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èŠ‚ç‚¹ç¼–è¾‘å™¨                                  [ä¿å­˜][åŠ è½½]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Result   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Number  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  Output  â”‚                      â”‚
â”‚  â”‚         â”‚            â”‚          â”‚                      â”‚
â”‚  â”‚ Value:  â”‚            â”‚ Result:  â”‚                      â”‚
â”‚  â”‚ [10]    â”‚            â”‚ [10]     â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Result   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚  Math   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  Output  â”‚                      â”‚
â”‚  â”‚         â”‚            â”‚          â”‚                      â”‚
â”‚  â”‚ A [â—‹]   â”‚            â”‚ Input:   â”‚                      â”‚
â”‚  â”‚         â”‚            â”‚ [0]      â”‚                      â”‚
â”‚  â”‚ B [â—‹]   â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚  â”‚ Add â–¼   â”‚                                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚                                                            â”‚
â”‚  å³é”®æ‰“å¼€èœå•åˆ›å»ºèŠ‚ç‚¹                                       â”‚
â”‚  æ‹–åŠ¨ç«¯å£è¿æ¥èŠ‚ç‚¹                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¹ã€è¿›é˜¶åŠŸèƒ½

### 9.1 èŠ‚ç‚¹åˆ†ç»„

```csharp
// åˆ›å»ºåˆ†ç»„
public class NodeGroup : GraphElement
{
    private string title = "Group";

    public NodeGroup()
    {
        var titleField = new Label(title);
        titleField.style.backgroundColor = new StyleColor(new Color(0.2f, 0.2f, 0.2f, 0.8f));
        titleField.style.paddingTop = 5;
        titleField.style.paddingLeft = 5;
        titleField.style.paddingBottom = 5;
        Add(titleField);

        capabilities |= Capabilities.Selectable | Capabilities.Movable | Capabilities.Deletable;
    }
}
```

### 9.2 èŠ‚ç‚¹æœç´¢

```csharp
public class NodeSearchWindow : ScriptableObject, ISearchWindowProvider
{
    public List<SearchTreeEntry> CreateSearchTree(SearchWindowContext context)
    {
        var tree = new List<SearchTreeEntry>
        {
            new SearchTreeGroupEntry(new GUIContent("èŠ‚ç‚¹åˆ›å»º"), 0),

            // æ•°å­¦åˆ†ç±»
            new SearchTreeGroupEntry(new GUIContent("æ•°å­¦è¿ç®—"), 1),
            new SearchTreeEntry(new GUIContent("åŠ æ³•")) { level = 2, userData = typeof(AddNode) },
            new SearchTreeEntry(new GUIContent("å‡æ³•")) { level = 2, userData = typeof(SubtractNode) },
            new SearchTreeEntry(new GUIContent("ä¹˜æ³•")) { level = 2, userData = typeof(MultiplyNode) },
            new SearchTreeEntry(new GUIContent("é™¤æ³•")) { level = 2, userData = typeof(DivideNode) },

            // é€»è¾‘åˆ†ç±»
            new SearchTreeGroupEntry(new GUIContent("é€»è¾‘è¿ç®—"), 1),
            new SearchTreeEntry(new GUIContent("ä¸")) { level = 2, userData = typeof(AndNode) },
            new SearchTreeEntry(new GUIContent("æˆ–")) { level = 2, userData = typeof(OrNode) },
            new SearchTreeEntry(new GUIContent("é")) { level = 2, userData = typeof(NotNode) },

            // å…¶ä»–...
        };
        return tree;
    }

    public bool OnSelectEntry(SearchTreeEntry entry, SearchWindowContext context)
    {
        // åˆ›å»ºé€‰ä¸­èŠ‚ç‚¹
        return true;
    }
}
```

### 9.3 å®æ—¶è®¡ç®—

```csharp
public class GraphEvaluator
{
    private Dictionary<string, object> nodeValues = new Dictionary<string, object>();

    public object EvaluateNode(BaseNode node)
    {
        // å¦‚æœå·²è®¡ç®—è¿‡ï¼Œè¿”å›ç¼“å­˜å€¼
        if (nodeValues.ContainsKey(node.GUID))
        {
            return nodeValues[node.GUID];
        }

        object result = null;

        if (node is NumberNode numberNode)
        {
            result = numberNode.Value;
        }
        else if (node is MathNode mathNode)
        {
            var inputA = GetInputValue(mathNode, 0);
            var inputB = GetInputValue(mathNode, 1);
            result = CalculateMath(inputA, inputB, mathNode.operation);
        }

        // ç¼“å­˜ç»“æœ
        nodeValues[node.GUID] = result;
        return result;
    }

    private float GetInputValue(BaseNode node, int portIndex)
    {
        var port = node.inputContainer.Children().ElementAt(portIndex) as Port;
        if (port?.connections?.Count() > 0)
        {
            var connectedPort = port.connections.First().output;
            var connectedNode = connectedPort.node as BaseNode;
            return (float)EvaluateNode(connectedNode);
        }
        return 0f;
    }

    private float CalculateMath(float a, float b, MathOperation op)
    {
        switch (op)
        {
            case MathOperation.Add: return a + b;
            case MathOperation.Subtract: return a - b;
            case MathOperation.Multiply: return a * b;
            case MathOperation.Divide: return a / (b != 0 ? b : 1);
            default: return 0f;
        }
    }
}
```

---

## åã€æ€»ç»“

æœ¬æ–‡ä»‹ç»äº†åˆ›å»ºç®€å•èŠ‚ç‚¹ç¼–è¾‘å™¨çš„æ ¸å¿ƒè¦ç‚¹ï¼š

| ä¸»é¢˜ | è¦ç‚¹ |
|------|------|
| **GraphView** | Unity 2019+ çš„èŠ‚ç‚¹ç¼–è¾‘æ¡†æ¶ |
| **Node** | èŠ‚ç‚¹åŸºç±»ï¼ŒåŒ…å«ç«¯å£å’Œå†…å®¹ |
| **Port** | è¾“å…¥/è¾“å‡ºç«¯å£ï¼Œç”¨äºè¿æ¥èŠ‚ç‚¹ |
| **Edge** | è¿æ¥ç«¯å£çš„æ•°æ®æµ |
| **SearchWindow** | å³é”®èœå•æœç´¢åˆ›å»ºèŠ‚ç‚¹ |
| **åºåˆ—åŒ–** | ä¿å­˜/åŠ è½½èŠ‚ç‚¹å›¾æ•°æ® |
| **USS æ ·å¼** | è‡ªå®šä¹‰èŠ‚ç‚¹ç¼–è¾‘å™¨å¤–è§‚ |
| **è®¡ç®—ç³»ç»Ÿ** | å®æ—¶è®¡ç®—èŠ‚ç‚¹ç»“æœ |

> ğŸ’¡ **å¼€å‘å»ºè®®**ï¼š
> - ä½¿ç”¨ GraphView æ¡†æ¶å¿«é€Ÿæ­å»ºèŠ‚ç‚¹ç¼–è¾‘å™¨
> - èŠ‚ç‚¹æ•°æ®ä½¿ç”¨ Serializable ç±»ä¾¿äºåºåˆ—åŒ–
> - ä½¿ç”¨ USS æ ·å¼ç¾åŒ–ç•Œé¢
> - è€ƒè™‘æ·»åŠ æ’¤é”€/é‡åšåŠŸèƒ½
> - å¤§å‹é¡¹ç›®å¯å‚è€ƒ XNode çš„è®¾è®¡æ€è·¯

---

**è½¬è½½è¯·æ³¨æ˜æ¥æº**ï¼Œæ¬¢è¿å¯¹æ–‡ç« ä¸­çš„å¼•ç”¨æ¥æºè¿›è¡Œè€ƒè¯ï¼Œæ¬¢è¿æŒ‡å‡ºä»»ä½•æœ‰é”™è¯¯æˆ–ä¸å¤Ÿæ¸…æ™°çš„è¡¨è¾¾ã€‚å¯ä»¥åœ¨ä¸‹é¢è¯„è®ºåŒºè¯„è®ºï¼Œä¹Ÿå¯ä»¥é‚®ä»¶è‡³ 1487842110@qq.com
